<?php
/**
 * Admin configuration view for Datencheck module
 * 
 * Available variables:
 * @var string $title Module title
 * @var string $fuzzy_diff_high_age Current high age threshold
 * @var string $fuzzy_diff_default Current default threshold
 * @var string $csrf CSRF token field (HTML)
 * @var string $control_panel_url URL to control panel
 * @var string $modules_all_url URL to modules page
 * @var string $i18n_control_panel Translated "Control panel"
 * @var string $i18n_modules Translated "Modules"
 * @var string $i18n_save Translated "save"
 * @var string $i18n_cancel Translated "cancel"
 * @var DatencheckModule $module Module instance
 */
?>

<?= view('components/breadcrumbs', ['links' => $breadcrumb_links]) ?>

<h1><?= htmlspecialchars($title) ?></h1>

<form method="post" class="form-horizontal">
    <?= $csrf ?>
    <input type="hidden" name="tree_context" value="<?= htmlspecialchars($tree_name) ?>">
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="datencheckTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="general-tab" data-bs-toggle="tab" href="#general" role="tab" aria-controls="general" aria-selected="true"><?= \Fisharebest\Webtrees\I18N::translate('General') ?></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="plausibility-tab" data-bs-toggle="tab" href="#plausibility" role="tab" aria-controls="plausibility" aria-selected="false"><?= \Fisharebest\Webtrees\I18N::translate('Plausibility') ?></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="features-tab" data-bs-toggle="tab" href="#features" role="tab" aria-controls="features" aria-selected="false"><?= \Fisharebest\Webtrees\I18N::translate('Features') ?></a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="analysis-tab" data-bs-toggle="tab" href="#analysis" role="tab" aria-controls="analysis" aria-selected="false"><?= \Fisharebest\Webtrees\I18N::translate('Analysis') ?></a>
        </li>
    </ul>

    <div class="tab-content" id="datencheckTabsContent">
        <!-- Tab 1: General Settings -->
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <!-- Content omitted for brevity, keeping existing structure -->
            <div class="rowMK mb-3"> 
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label" for="fuzzy_diff_high_age">
                        <?= \Fisharebest\Webtrees\I18N::translate('Fuzzy threshold for high age (>80 years)') ?>
                    </label>
                    <div class="col-sm-9">
                        <input 
                            type="number" 
                            class="form-control" 
                            id="fuzzy_diff_high_age" 
                            name="fuzzy_diff_high_age" 
                            value="<?= htmlspecialchars($fuzzy_diff_high_age) ?>"
                            min="0"
                            max="20"
                            required
                        >
                        <small class="form-text text-muted">
                            <?= \Fisharebest\Webtrees\I18N::translate('Max year deviation for birth dates if person lived >80 years (higher uncertainty in old records).') ?>
                        </small>
                    </div>
                </div>
                
                <div class="form-group row mt-3">
                    <label class="col-sm-3 col-form-label" for="fuzzy_diff_default">
                        <?= \Fisharebest\Webtrees\I18N::translate('Fuzzy threshold (default)') ?>
                    </label>
                    <div class="col-sm-9">
                        <input 
                            type="number" 
                            class="form-control" 
                            id="fuzzy_diff_default" 
                            name="fuzzy_diff_default" 
                            value="<?= htmlspecialchars($fuzzy_diff_default) ?>"
                            min="0"
                            max="10"
                            required
                        >
                        <small class="form-text text-muted">
                            <?= \Fisharebest\Webtrees\I18N::translate('Max year deviation for birth dates in most cases (baptismal, marriage records).') ?>
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <h4><i class="fa fa-info-circle"></i> <?= \Fisharebest\Webtrees\I18N::translate('Help: General') ?></h4>
                <p><?= \Fisharebest\Webtrees\I18N::translate('These settings control the sensitivity of the automatic duplicate detection.') ?></p>
                <ul>
                    <li><strong><?= \Fisharebest\Webtrees\I18N::translate('Fuzzy matching:') ?></strong> <?= \Fisharebest\Webtrees\I18N::translate('Use algorithms (e.g. Levenshtein distance) to tolerate typos in names.') ?></li>
                    <li><strong><?= \Fisharebest\Webtrees\I18N::translate('Warning thresholds:') ?></strong> <?= \Fisharebest\Webtrees\I18N::translate('A higher value means more tolerance for date deviations.') ?></li>
                </ul>
            </div>
        </div>

        <!-- Tab 2: Plausibility Settings -->
        <div class="tab-pane fade" id="plausibility" role="tabpanel" aria-labelledby="plausibility-tab">
            <!-- Content omitted, existing structure maintained -->
            <h3><?= \Fisharebest\Webtrees\I18N::translate('Validation settings') ?></h3>
            
            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="max_marriages_warning">
                    <?= \Fisharebest\Webtrees\I18N::translate('Max. Marriages Warning') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="max_marriages_warning" 
                        name="max_marriages_warning" 
                        value="<?= htmlspecialchars($module->getSetting('max_marriages_warning', '5')) ?>"
                        min="1"
                        max="20"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Number of marriages from which a warning is displayed (default: 5).') ?>
                    </small>
                </div>
            </div>
            
            <hr class="my-4">
            <h3><?= \Fisharebest\Webtrees\I18N::translate('Biological & Temporal Plausibility Thresholds') ?></h3>
            
            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="min_mother_age">
                    <?= \Fisharebest\Webtrees\I18N::translate('Min. Mother Age at Birth') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="min_mother_age" 
                        name="min_mother_age" 
                        value="<?= htmlspecialchars($module->getSetting('min_mother_age', '14')) ?>"
                        min="10"
                        max="20"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Error if mother was younger (default: 14 years).') ?>
                    </small>
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="max_mother_age">
                    <?= \Fisharebest\Webtrees\I18N::translate('Max. Mother Age at Birth') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="max_mother_age" 
                        name="max_mother_age" 
                        value="<?= htmlspecialchars($module->getSetting('max_mother_age', '50')) ?>"
                        min="40"
                        max="70"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Warning if mother was older (default: 50 years).') ?>
                    </small>
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="min_father_age">
                    <?= \Fisharebest\Webtrees\I18N::translate('Min. Father Age at Birth') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="min_father_age" 
                        name="min_father_age" 
                        value="<?= htmlspecialchars($module->getSetting('min_father_age', '14')) ?>"
                        min="10"
                        max="20"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Error if father was younger (default: 14 years).') ?>
                    </small>
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="max_father_age">
                    <?= \Fisharebest\Webtrees\I18N::translate('Max. Father Age at Birth') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="max_father_age" 
                        name="max_father_age" 
                        value="<?= htmlspecialchars($module->getSetting('max_father_age', '80')) ?>"
                        min="60"
                        max="100"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Warning if father was older (default: 80 years).') ?>
                    </small>
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="max_lifespan">
                    <?= \Fisharebest\Webtrees\I18N::translate('Max. Lifespan') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="max_lifespan" 
                        name="max_lifespan" 
                        value="<?= htmlspecialchars($module->getSetting('max_lifespan', '120')) ?>"
                        min="100"
                        max="150"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Warning at unusually long lifespan (default: 120 years).') ?>
                    </small>
                </div>
            </div>

            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="max_marriage_age_warning">
                    <?= \Fisharebest\Webtrees\I18N::translate('Max. Marriage Age') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="max_marriage_age_warning" 
                        name="max_marriage_age_warning" 
                        value="<?= htmlspecialchars($module->getSetting('max_marriage_age_warning', '100')) ?>"
                        min="60"
                        max="120"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Warning at unusually late marriage age (default: 100 years).') ?>
                    </small>
                </div>
            </div>

            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="min_marriage_age_warning">
                    <?= \Fisharebest\Webtrees\I18N::translate('Min. Marriage Age') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="min_marriage_age_warning" 
                        name="min_marriage_age_warning" 
                        value="<?= htmlspecialchars($module->getSetting('min_marriage_age_warning', '15')) ?>"
                        min="10"
                        max="30"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Warning at unusually early marriage age (default: 15 years).') ?>
                    </small>
                </div>
            </div>

            <div class="form-group row mb-3">
                <label class="col-sm-3 col-form-label" for="min_sibling_spacing_warning">
                    <?= \Fisharebest\Webtrees\I18N::translate('Sibling Spacing') ?>
                </label>
                <div class="col-sm-9">
                    <input 
                        type="number" 
                        class="form-control" 
                        id="min_sibling_spacing_warning" 
                        name="min_sibling_spacing_warning" 
                        value="<?= htmlspecialchars($module->getSetting('min_sibling_spacing_warning', '9')) ?>"
                        min="1"
                        max="24"
                        required
                    >
                    <small class="form-text text-muted">
                        <?= \Fisharebest\Webtrees\I18N::translate('Warning if births are too close together (in months, default: 9).') ?>
                    </small>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <h4><i class="fa fa-info-circle"></i> <?= \Fisharebest\Webtrees\I18N::translate('Help: Plausibility') ?></h4>
                <p><?= \Fisharebest\Webtrees\I18N::translate('Define boundaries for biological and temporal checks.') ?></p>
                <ul>
                    <li><strong><?= \Fisharebest\Webtrees\I18N::translate('Parents Age:') ?></strong> <?= \Fisharebest\Webtrees\I18N::translate('Warns of biologically unlikely age at the birth of the child.') ?></li>
                    <li><strong><?= \Fisharebest\Webtrees\I18N::translate('Sibling Spacing:') ?></strong> <?= \Fisharebest\Webtrees\I18N::translate('Warns if births are too close together (< 9 months).') ?></li>
                </ul>
            </div>
        </div>

        <!-- Tab 3: Additional Features Settings -->
        <div class="tab-pane fade" id="features" role="tabpanel" aria-labelledby="features-tab">
            <div class="row mb-3">
                <div class="col-sm-3">
                    <strong><?= \Fisharebest\Webtrees\I18N::translate('Optional Checks') ?></strong>
                </div>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_missing_data_checks" 
                            name="enable_missing_data_checks" 
                            value="1"
                            <?= $module->getSetting('enable_missing_data_checks', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_missing_data_checks">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Check missing data') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Warns for: Child without birth date, death without birth, family without children') ?></small>
                        </label>
                    </div>
                    
                    <div class="form-check mt-3">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_geographic_checks" 
                            name="enable_geographic_checks" 
                            value="1"
                            <?= $module->getSetting('enable_geographic_checks', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_geographic_checks">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Check geographic plausibility') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Warns for: Large distance between birth/death locations, invalid locations') ?></small>
                        </label>
                    </div>
                    
                    <div class="form-check mt-3">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_name_consistency_checks" 
                            name="enable_name_consistency_checks" 
                            value="1"
                            <?= $module->getSetting('enable_name_checks', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_name_consistency_checks">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Check name consistency') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Warns for: Empty names, only given or surname, special character issues') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-2 ms-4">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_scandinavian_patronymics" 
                            name="enable_scandinavian_patronymics" 
                            value="1"
                            <?= $module->getSetting('enable_scand_patronym', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_scandinavian_patronymics">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Consider Scandinavian naming conventions') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Tolerates patronymics (e.g. -sen/-son/-datter) when comparing with father/mother.') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-2 ms-4">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_slavic_surnames" 
                            name="enable_slavic_surnames" 
                            value="1"
                            <?= $module->getSetting('enable_slavic_surnames', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_slavic_surnames">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Consider Slavic naming conventions') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Tolerates gendered surnames (e.g. -ski/-ska, -ov/-ova).') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-2 ms-4">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_spanish_surnames" 
                            name="enable_spanish_surnames" 
                            value="1"
                            <?= $module->getSetting('enable_spanish_surnames', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_spanish_surnames">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Consider Spanish double surnames') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Tolerates combinations of father and mother surnames.') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-2 ms-4">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_dutch_tussenvoegsels" 
                            name="enable_dutch_tussenvoegsels" 
                            value="1"
                            <?= $module->getSetting('enable_dutch_tussenvoegsels', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_dutch_tussenvoegsels">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Consider Dutch tussenvoegsels') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Ignores prefixes like "van", "de", "van der" during comparison.') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-2 ms-4">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_greek_surnames" 
                            name="enable_greek_surnames" 
                            value="1"
                            <?= $module->getSetting('enable_greek_surnames', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_greek_surnames">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Consider Greek naming conventions') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Tolerates gendered suffixes (e.g. -is/-ou).') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-2 ms-4">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_genannt_names" 
                            name="enable_genannt_names" 
                            value="1"
                            <?= $module->getSetting('enable_genannt_names', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_genannt_names">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Consider Genannt-Namen (alias) naming conventions') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Tolerates alias names (Westphalian: "genannt", "gen.", "vulgo", "dictus"; Polish/Latin: "vel", "alias", "zwany", "inaczej").') ?></small>
                        </label>
                    </div>
                    
                    <div class="form-check mt-3">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_imprecise_dates" 
                            name="enable_imprecise_dates" 
                            value="1"
                            <?= $module->getSetting('enable_imprecise_dates', '1') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_imprecise_dates">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Show warnings for imprecise dates') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('If disabled, conflicts caused by missing day/month (e.g. "1855" vs "May 1855") will be ignored.') ?></small>
                        </label>
                    </div>

                    <div class="form-check mt-3">
                        <input 
                            class="form-check-input" 
                            type="checkbox" 
                            id="enable_source_checks" 
                            name="enable_source_checks" 
                            value="1"
                            <?= $module->getSetting('enable_source_checks', '0') === '1' ? 'checked' : '' ?>
                        >
                        <label class="form-check-label" for="enable_source_checks">
                            <strong><?= \Fisharebest\Webtrees\I18N::translate('Check source requirement') ?></strong><br>
                            <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('Warns for: Facts without source citations') ?></small>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-4">
                <h4><i class="fa fa-info-circle"></i> <?= \Fisharebest\Webtrees\I18N::translate('Help: Features') ?></h4>
                <p><?= \Fisharebest\Webtrees\I18N::translate('Enable specialized validations for your family tree.') ?></p>
                <ul>
                    <li><strong><?= \Fisharebest\Webtrees\I18N::translate('Geography:') ?></strong> <?= \Fisharebest\Webtrees\I18N::translate('Warns about unrealistically fast travel (>500km in < 2 days).') ?></li>
                    <li><strong><?= \Fisharebest\Webtrees\I18N::translate('Sources:') ?></strong> <?= \Fisharebest\Webtrees\I18N::translate('Highlights important events (birth, death, marriage) without source citation.') ?></li>
                </ul>
            </div>
        </div>

        <!-- Tab 4: Analysis/Bulk Check -->
        <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
            <div class="alert alert-light border">
                <h4><i class="fa fa-stethoscope"></i> <?= \Fisharebest\Webtrees\I18N::translate('Quality Analysis') ?></h4>
                <p><?= \Fisharebest\Webtrees\I18N::translate('This function checks <strong>all persons</strong> in the tree for the problems enabled above.') ?></p>
                <hr>
                
                <?php if (count($trees_list) > 1): ?>
                <div class="form-group row mb-4">
                     <label class="col-sm-3 col-form-label" for="analysis_tree_select">
                        <?= \Fisharebest\Webtrees\I18N::translate('Select tree:') ?>
                    </label>
                    <div class="col-sm-6">
                        <select class="form-control form-select" id="analysis_tree_select">
                            <?php foreach($trees_list as $t_name => $t_title): ?>
                                <option value="<?= htmlspecialchars($t_name) ?>" <?= $t_name === $tree_name ? 'selected' : '' ?>>
                                    <?= htmlspecialchars($t_title) ?>
                                </option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                </div>
                <?php else: ?>
                    <p><?= \Fisharebest\Webtrees\I18N::translate('Active tree:') ?> <strong><?= htmlspecialchars($tree_title) ?></strong></p>
                    <input type="hidden" id="analysis_tree_select" value="<?= htmlspecialchars($tree_name) ?>">
<?php endif; ?>

                <div class="mb-4">
                    <label class="form-label d-block fw-bold"><?= \Fisharebest\Webtrees\I18N::translate('Categories to analyze:') ?></label>
                    <div class="d-flex flex-wrap gap-3 p-3 bg-white border rounded">
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="biological" id="chk_bio" checked>
                            <label class="form-check-label" for="chk_bio"><?= \Fisharebest\Webtrees\I18N::translate('Biological Plausibility') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="temporal" id="chk_temp" checked>
                            <label class="form-check-label" for="chk_temp"><?= \Fisharebest\Webtrees\I18N::translate('Temporal Plausibility') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="marriage" id="chk_marr" checked>
                            <label class="form-check-label" for="chk_marr"><?= \Fisharebest\Webtrees\I18N::translate('Marriage Plausibility') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="missing_data" id="chk_miss" checked>
                            <label class="form-check-label" for="chk_miss"><?= \Fisharebest\Webtrees\I18N::translate('Missing Data') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="geographic" id="chk_geo" checked>
                            <label class="form-check-label" for="chk_geo"><?= \Fisharebest\Webtrees\I18N::translate('Geographic Plausibility') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="names" id="chk_name" checked>
                            <label class="form-check-label" for="chk_name"><?= \Fisharebest\Webtrees\I18N::translate('Name Consistency') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="sources" id="chk_src" checked>
                            <label class="form-check-label" for="chk_src"><?= \Fisharebest\Webtrees\I18N::translate('Source Quality') ?></label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input analysis-category" type="checkbox" value="date_format" id="chk_date" checked>
                            <label class="form-check-label" for="chk_date"><?= \Fisharebest\Webtrees\I18N::translate('Date Format') ?></label>
                        </div>
                    </div>
                    <small class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('If categories are selected here, they will override the general settings for this analysis run.') ?></small>
                </div>

                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-success btn-lg me-3" id="btn-start-analysis">
                        <i class="fa fa-play"></i> <?= \Fisharebest\Webtrees\I18N::translate('Start Analysis') ?>
                    </button>
                    <?php if ($tree): ?>
                    <a href="<?= $tree_url ?>" class="btn btn-outline-secondary btn-lg me-3">
                         <i class="fa fa-home"></i> <?= \Fisharebest\Webtrees\I18N::translate('Back to tree') ?>
                    </a>
                    <?php endif; ?>
                    <div class="flex-grow-1 ms-3" style="display:none;" id="progress-container">
                        <label><?= \Fisharebest\Webtrees\I18N::translate('Processing individuals:') ?> <span id="progress-text">0 / 0</span></label>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" id="analysis-progress" style="width: 0%">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="card mt-4 mb-3 shadow-sm" id="analysis-controls" style="display:none;">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <strong><i class="fa fa-filter"></i> <?= \Fisharebest\Webtrees\I18N::translate('Filter Results') ?></strong>
                    <button class="btn btn-sm btn-outline-primary" id="btn-export-csv">
                        <i class="fa fa-download"></i> <?= \Fisharebest\Webtrees\I18N::translate('Export CSV') ?>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="filter-severity" class="form-label"><?= \Fisharebest\Webtrees\I18N::translate('Severity') ?></label>
                            <select class="form-select form-control" id="filter-severity">
                                <option value="all"><?= \Fisharebest\Webtrees\I18N::translate('Show all problems') ?></option>
                                <option value="error"><?= \Fisharebest\Webtrees\I18N::translate('Errors only (Red)') ?></option>
                                <option value="warning"><?= \Fisharebest\Webtrees\I18N::translate('Warnings (Yellow)') ?></option>
                                <option value="info"><?= \Fisharebest\Webtrees\I18N::translate('Info (Blue)') ?></option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filter-category" class="form-label"><?= \Fisharebest\Webtrees\I18N::translate('Category / Error Type') ?></label>
                            <select class="form-select form-control" id="filter-category">
                                <option value="all"><?= \Fisharebest\Webtrees\I18N::translate('All Categories') ?></option>
                                <option value="biological"><?= \Fisharebest\Webtrees\I18N::translate('Biological Plausibility') ?></option>
                                <option value="temporal"><?= \Fisharebest\Webtrees\I18N::translate('Temporal Plausibility') ?></option>
                                <option value="marriage"><?= \Fisharebest\Webtrees\I18N::translate('Marriage Plausibility') ?></option>
                                <option value="missing_data"><?= \Fisharebest\Webtrees\I18N::translate('Missing Data') ?></option>
                                <option value="geography"><?= \Fisharebest\Webtrees\I18N::translate('Geographic Plausibility') ?></option>
                                <option value="names"><?= \Fisharebest\Webtrees\I18N::translate('Name Consistency') ?></option>
                                <option value="missing_source"><?= \Fisharebest\Webtrees\I18N::translate('Source Quality') ?></option>
                                <option value="duplicate_check"><?= \Fisharebest\Webtrees\I18N::translate('Possible Duplicates') ?></option>
                                <option value="sibling_spacing"><?= \Fisharebest\Webtrees\I18N::translate('Sibling Spacing') ?></option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end justify-content-end">
                            <div class="text-end">
                                <span class="fs-4 fw-bold" id="visible-count">0</span>
                                <span class="text-muted"><?= \Fisharebest\Webtrees\I18N::translate('of') ?> <span id="total-results-count">0</span> <?= \Fisharebest\Webtrees\I18N::translate('shown') ?></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analysis-results" style="display:none;" class="mt-4">
                <h5><?= \Fisharebest\Webtrees\I18N::translate('Issues Found') ?> <span class="badge bg-danger" id="issue-count">0</span></h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mt-3" id="results-table">
                        <thead>
                        <tr>
                            <th scope="col"><?= \Fisharebest\Webtrees\I18N::translate('Person') ?></th>
                            <th scope="col"><?= \Fisharebest\Webtrees\I18N::translate('Code / Type') ?></th>
                            <th scope="col"><?= \Fisharebest\Webtrees\I18N::translate('Description') ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Results via JS -->
                    </tbody>
                </table>
            </div>
</div>
        </div>
    </div>
    
    <div class="row mb-3 mt-4">
        <div class="offset-sm-3 col-sm-9">
            <button type="submit" class="btn btn-primary">
                <?= \Fisharebest\Webtrees\I18N::translate('save') ?>
            </button>
            <span class="text-muted ms-3 small">
                <i class="fa fa-user-circle"></i> <?= \Fisharebest\Webtrees\I18N::translate('These settings are saved for your user account.') ?>
            </span>
            
            <a href="<?= $control_panel_url ?>" class="btn btn-secondary ms-2">
                <?= \Fisharebest\Webtrees\I18N::translate('cancel') ?>
            </a>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('btn-start-analysis');
    const filterControls = document.getElementById('analysis-controls');
    const filterSeverity = document.getElementById('filter-severity');
    const filterCategory = document.getElementById('filter-category');
    const visibleCountEl = document.getElementById('visible-count');
    const totalResultsCountEl = document.getElementById('total-results-count');

    const progressContainer = document.getElementById('progress-container');
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('analysis-progress');
    const resultsContainer = document.getElementById('analysis-results');
    const resultsTableBody = document.querySelector('#results-table tbody');
    const issueCountBadge = document.getElementById('issue-count');

    // Translated strings for JS
    const i18n = {
        analyzing: '<?= \Fisharebest\Webtrees\I18N::translate('Analyzing...') ?>',
        initializing: '<?= \Fisharebest\Webtrees\I18N::translate('Initializing...') ?>',
        done: '<?= \Fisharebest\Webtrees\I18N::translate('Done!') ?>',
        noIssuesFound: '<?= \Fisharebest\Webtrees\I18N::translate('No issues found!') ?>',
        cleanTree: '<?= \Fisharebest\Webtrees\I18N::translate('Your tree is clean.') ?>',
        analysisError: '<?= \Fisharebest\Webtrees\I18N::translate('Analysis error:') ?>',
        errorRestart: '<?= \Fisharebest\Webtrees\I18N::translate('Error! Restart?') ?>',
        tooManyIssues: '<?= \Fisharebest\Webtrees\I18N::translate('Too many issues found. Showing only the first %s. Please use CSV Export for the full list.', 1000) ?>'
    };

    let totalIssues = 0;
    let allFoundIssues = []; // ACCUMULATE ALL ISSUES FOR CSV
    const RENDER_LIMIT = 1000;
    
    // API Route Base
    const apiRouteBase = '<?= e(route('module', ['module' => $module->name(), 'action' => 'BatchAnalysis', 'tree' => 'TREE_PLACEHOLDER'])) ?>';
    
    // Helper to get current tree from dropdown or hidden input
    function getSelectedTree() {
        const select = document.getElementById('analysis_tree_select');
        return select ? select.value : '<?= $tree_name ?>';
    }
    
    // We use a safe dummy XREF 'I1' (standard GEDCOM ID format)
    // 'X0' caused issues with some regex validations in webtrees routing
    // We decode the URL because webtrees' router might encode special characters if they were present
    const personUrlBase = decodeURIComponent('<?= e(route(Fisharebest\Webtrees\Http\RequestHandlers\IndividualPage::class, ['tree' => 'TREE0', 'xref' => 'I1'])) ?>');
    
    // Base URL for tree home (Tree Welcome Page)
    const treeHomeUrlBase = '<?= e(route(Fisharebest\Webtrees\Http\RequestHandlers\TreePage::class, ['tree' => 'TREE0'])) ?>';

    // Update "Back to tree" button when dropdown changes
    const treeSelect = document.getElementById('analysis_tree_select');
    const backBtn = document.querySelector('.btn-outline-secondary');
    
    if (treeSelect && backBtn) {
        treeSelect.addEventListener('change', () => {
             const selectedTree = treeSelect.value;
             // Use the specific tree home base URL
             let newUrl = treeHomeUrlBase.replace('TREE0', selectedTree);
             backBtn.href = newUrl;
        });
    }

    // Filter Logic
    function applyFilters() {
        const severity = filterSeverity.value;
        const category = filterCategory.value;
        const rows = resultsTableBody.querySelectorAll('tr');
        let visible = 0;

        rows.forEach(row => {
            if (row.id === 'render-limit-warning') return; // Skip the warning row
            const rowSev = row.getAttribute('data-severity'); // error, warning, info
            const rowCat = row.getAttribute('data-category'); // e.g. missing_source

            let show = true;

            // Filter Severity
            if (severity !== 'all') {
                if (severity === 'error' && rowSev !== 'error') show = false;
                if (severity === 'warning' && rowSev !== 'warning') show = false;
                if (severity === 'info' && rowSev !== 'info') show = false;
            }

            // Filter Category
            if (category !== 'all') {
                if (category === 'biological' && !rowCat.includes('biological') && rowCat !== 'sibling_spacing') show = false;
                else if (category === 'temporal' && !rowCat.includes('temporal') && rowCat !== 'chronological_inconsistency') show = false;
                else if (category === 'marriage' && !rowCat.includes('marriage')) show = false;
                else if (category === 'geography' && rowCat !== 'geographic_issue') show = false;
                else if (category === 'names' && rowCat !== 'name_consistency') show = false;
                else if (category !== 'biological' && category !== 'temporal' && category !== 'marriage' && category !== 'geography' && category !== 'names' && rowCat !== category && rowCat !== 'unknown') show = false;
            }

            row.style.display = show ? '' : 'none';
            if (show) visible++;
        });

        visibleCountEl.innerText = visible;
    }

    filterSeverity.addEventListener('change', applyFilters);
    filterCategory.addEventListener('change', applyFilters);

    btn.addEventListener('click', async () => {
        // Reset UI
        btn.disabled = true;
        btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ${i18n.analyzing}`;
        progressContainer.style.display = 'block';
        resultsContainer.style.display = 'none';
        filterControls.style.display = 'none'; // Hide filters during run
        resultsTableBody.innerHTML = '';
        progressBar.style.width = '0%';
        progressBar.innerText = '0%';
        progressBar.classList.add('progress-bar-animated');
        progressBar.classList.remove('bg-primary');
        progressBar.classList.remove('bg-danger'); // Ensure it's clean on restart
        progressBar.classList.add('bg-success');
        
        progressText.innerText = i18n.initializing;
        totalIssues = 0;
        allFoundIssues = []; // Reset for new analysis
        issueCountBadge.innerText = '0';
        visibleCountEl.innerText = '0';
        totalResultsCountEl.innerText = '0';

        // Collect selected categories
        const selectedCats = Array.from(document.querySelectorAll('.analysis-category:checked')).map(cb => cb.value);
        const categoriesStr = selectedCats.join(',');
        
        await runBatch('', getSelectedTree(), 0, 0, categoriesStr);
    });

    async function runBatch(lastId, treeName, totalCountFromClient, processed, categories) {
        try {
            // Construct API URL with selected tree
            let url = apiRouteBase.replace('TREE_PLACEHOLDER', treeName);
            const separator = url.includes('?') ? '&' : '?';
            
            const response = await fetch(`${url}${separator}last_id=${lastId}&limit=100&total=${totalCountFromClient}&processed=${processed}&categories=${categories}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status} - ${errorText.substring(0, 100)}...`);
            }
            
            let data;
            try {
                data = await response.json();
            } catch (e) {
                console.error('Server response was not JSON:', await response.text());
                throw new Error('Server response was not valid JSON.');
            }

            if (data.error) {
                throw new Error(`Server Error: ${data.message} (File: ${data.file}, Line: ${data.line})`);
            }

            // Update Progress
            const percentage = data.total > 0 ? Math.round((data.offset / data.total) * 100) : 0;
            progressBar.style.width = `${percentage}%`;
            progressBar.innerText = `${percentage}%`;
            progressText.innerText = `${data.offset} / ${data.total}`;

            // Handle Results
            if (data.issues && data.issues.length > 0) {
                allFoundIssues = allFoundIssues.concat(data.issues); // Accumulate all issues
                totalIssues = allFoundIssues.length; // Total issues found so far
                issueCountBadge.innerText = totalIssues;
                totalResultsCountEl.innerText = totalIssues;

                resultsContainer.style.display = 'block'; // Show if issues found
                filterControls.style.display = 'block'; 
                
                data.issues.forEach(issue => {
                    // Only render if below the limit
                    if (resultsTableBody.children.length < RENDER_LIMIT) {
                        const row = document.createElement('tr');
                        
                        // Add data attributes for filtering
                        row.setAttribute('data-severity', issue.severity || 'info');
                        row.setAttribute('data-category', issue.type || 'unknown');
                        
                        // Severity badge
                        let badgeClass = 'bg-secondary';
                        if (issue.severity === 'error') badgeClass = 'bg-danger';
                        if (issue.severity === 'warning') badgeClass = 'bg-warning text-dark';
                        if (issue.severity === 'info') badgeClass = 'bg-info text-dark';
                        
                        // Build Person URL dynamically
                        // Replace the tree placeholder and the dummy XREF 'I1'
                        let pUrl = personUrlBase.replace('TREE0', treeName).replace('I1', issue.xref);
                        
                        row.innerHTML = `
                            <td><a href="${pUrl}" target="_blank">${issue.name} <small class="text-muted">(${issue.xref})</small></a></td>
                            <td><span class="badge ${badgeClass}">${issue.label || issue.code}</span></td>
                            <td>${issue.message}</td>
                        `;
                        resultsTableBody.appendChild(row);
                    }
                });

                // Add a warning if the render limit is reached and not already present
                if (totalIssues >= RENDER_LIMIT && !document.getElementById('render-limit-warning')) {
                    const warnRow = document.createElement('tr');
                    warnRow.id = 'render-limit-warning';
                    warnRow.innerHTML = `<td colspan="3" class="text-center bg-warning text-dark font-weight-bold p-3">
                        <i class="fa fa-exclamation-triangle"></i> 
                        ${i18n.tooManyIssues.replace('%s', RENDER_LIMIT)}
                    </td>`;
                    resultsTableBody.appendChild(warnRow);
                }
                
                // Re-apply filters if user changed them during run
                if (filterSeverity.value !== 'all' || filterCategory.value !== 'all') {
                    applyFilters();
                } else {
                    // If no filters, visible count is the number of rendered rows (up to RENDER_LIMIT)
                    visibleCountEl.innerText = resultsTableBody.children.length - (document.getElementById('render-limit-warning') ? 1 : 0);
                }
            }

            // Continue or Finish
            if (!data.finished) {
                // Next Batch
                // setTimeout ensures UI update happens before next intensive task
                setTimeout(() => runBatch(data.last_id, treeName, data.total, data.processed, categories), 10);
            } else {
                // Done
                btn.disabled = false;
                btn.innerHTML = `<i class="fa fa-check"></i> ${i18n.done}`;
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.remove('bg-success');
                progressBar.classList.add('bg-primary');
                
                if (totalIssues === 0) {
                     resultsContainer.style.display = 'block';
                     resultsTableBody.innerHTML = `<tr><td colspan="3" class="text-center text-success py-4"><h4><i class="fa fa-check-circle"></i> ${i18n.noIssuesFound}</h4><p>${i18n.cleanTree}</p></td></tr>`;
                     filterControls.style.display = 'none'; // No need to filter nothing
                }
            }
        } catch (error) {
            console.error(error);
            alert(`${i18n.analysisError} ` + error.message);
            btn.disabled = false;
            btn.innerText = i18n.errorRestart;
            progressBar.classList.add('bg-danger');
        }
    }

    // CSV Export Function
    document.getElementById('btn-export-csv').addEventListener('click', () => {
        if (allFoundIssues.length === 0) return; // Don't export if no issues

        let csvContent = "\uFEFF"; // BOM for Excel compatibility
        
        // Add Header Row
        csvContent += '"Person";"XREF";"Type";"Message";"Severity"\r\n';

        allFoundIssues.forEach(issue => {
            // Escape double quotes by doubling them, then wrap in quotes
            const escapeAndQuote = (text) => `"${String(text).replace(/"/g, '""')}"`;

            let row = [
                escapeAndQuote(issue.name),
                escapeAndQuote(issue.xref),
                escapeAndQuote(issue.label || issue.code),
                escapeAndQuote(issue.message.replace(/(\r\n|\n|\r)/gm, " ").trim()), // Clean newlines from message
                escapeAndQuote(issue.severity)
            ];
            
            csvContent += row.join(";") + "\r\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `datencheck_analyse_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url); // Clean up the object URL
    });
});
</script>
