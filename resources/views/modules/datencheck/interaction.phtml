<?php
/**
 * @var string $check_url
 * @var string $sibling_url
 * @var string $family_url
 * @var string $details_url
 * @var string $family_details_url
 * @var string $validation_url
 * @var string $individual_url
 */
?>
<style>
    #datencheck-validation-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        width: 320px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.25);
        display: none;
        flex-direction: column;
        overflow: hidden;
        font-family: sans-serif;
        border: 1px solid rgba(0,0,0,0.1);
        animation: dcFadeIn 0.3s ease-out;
    }
    @keyframes dcFadeIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    #datencheck-validation-header {
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #666;
        user-select: none;
    }
    #datencheck-validation-header .close-btn {
        cursor: pointer;
        font-size: 20px;
        line-height: 1;
    }
    #datencheck-validation-body {
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
    }
    .dc-bubble-issue {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
    }
    .dc-bubble-issue:last-child { margin-bottom: 0; }
    .dc-issue-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .dc-issue-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .dc-issue-info { background: #d1e7dd; color: #0f5132; border-left: 4px solid #198754; }
    #comparison-current { background-color: #f0f7ff; border-color: #cce3ff !important; }
    #comparison-duplicate { background-color: #fff9eb; border-color: #ffecd1 !important; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let personTimeout = null;
    let familyTimeout = null;
    let siblingTimeout = null;
    let validationTimeout = null;
    
    const isXref = (val) => {
        if (!val || typeof val !== 'string') return false;
        const clean = val.replace(/@/g, '').trim();
        return clean.match(/^[IXF]\d+$/);
    };

    function makeDraggable(el, header) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        header.onmousedown = dragMouseDown;
        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            el.style.top = (el.offsetTop - pos2) + "px";
            el.style.left = (el.offsetLeft - pos1) + "px";
            el.style.bottom = "auto";
            el.style.right = "auto";
        }
        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    const checkDuplicate = (e) => {
        const given = document.querySelector('[id*="GIVN"]')?.value || "";
        const surname = document.querySelector('[id*="SURN"]')?.value || "";
        const birth = document.querySelector('[id*="BIRT"][id*="DATE"]')?.value || "";
        const death = document.querySelector('[id*="DEAT"][id*="DATE"]')?.value || "";
        const baptism = document.querySelector('[id*="BAPM"][id*="DATE"], [id*="CHR"][id*="DATE"]')?.value || "";
        const sex = document.querySelector('select[id*="SEX"], input[name*="SEX"]:checked')?.value || "";

        if (given.length < 2 && surname.length < 2) return;

        let marriedSurname = "";
        if (sex === "F") {
            // Try to find husband's surname from the form if we're adding a wife
            const husbName = document.querySelector('[id*="HUSB"]')?.parentElement?.innerText || 
                             document.querySelector('.indi-search[data-role="HUSB"]')?.innerText || "";
            if (husbName) {
                const parts = husbName.split(' ');
                marriedSurname = parts[parts.length - 1].replace(/[()]/g, '');
            }
        }

        const url = "<?= $check_url ?>?given_name=" + encodeURIComponent(given) + 
                    "&surname=" + encodeURIComponent(surname) + 
                    "&birth_date=" + encodeURIComponent(birth) +
                    "&death_date=" + encodeURIComponent(death) +
                    "&baptism_date=" + encodeURIComponent(baptism) +
                    "&sex=" + encodeURIComponent(sex) +
                    "&married_surname=" + encodeURIComponent(marriedSurname);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                let warningArea = document.getElementById("datencheck-warning");
                if (!warningArea) {
                    warningArea = document.createElement("div");
                    warningArea.id = "datencheck-warning";
                    warningArea.className = "alert alert-warning mt-2";
                    warningArea.style.display = "none";
                    const target = document.querySelector('[id*="INDI-NAME"]')?.closest(".card");
                    if (target) target.parentNode.insertBefore(warningArea, target);
                }

                if (data.data && data.data.length > 0) {
                    // Store current person info for comparison
                    const context = getContext();
                    
                    // Robust check: if we are in an "Add" context OR the current form has no XREF, it's NEW.
                    const form = e?.target?.closest('form');
                    const formXrefInput = form?.querySelector('input[name="xref"]');
                    const hasFormXref = formXrefInput && formXrefInput.value && formXrefInput.value.trim() !== "";
                    
                    const currentXref = (context.isAdd || !hasFormXref) ? "NEW" : getXref();
                    
                    let html = "<strong><?= \Fisharebest\Webtrees\I18N::translate('Possible duplicates found:') ?></strong><ul class='list-unstyled'>";
                    data.data.forEach(item => {
                        let label = item.name2 + " (" + item.id2 + ")";
                        if (item.phonetic_match) {
                            label += " <small class='text-muted'>(<?= \Fisharebest\Webtrees\I18N::translate('phonetically') ?>)</small>";
                        }
                        
                        // Add birth/death info with places
                        let details = "";
                        if (item.birth || item.death) {
                            const b = item.birth ? (item.birth.date || "").trim() : "";
                            const bp = item.birth ? (item.birth.place || "").trim() : "";
                            const d = item.death ? (item.death.date || "").trim() : "";
                            const dp = item.death ? (item.death.place || "").trim() : "";
                            
                            let bStr = b;
                            if (bp) bStr += (b ? ", " : "") + bp;
                            let dStr = d;
                            if (dp) dStr += (d ? ", " : "") + dp;
                            
                            details = " <small class='text-muted d-block' style='margin-left: 1.5rem'>(" + (bStr || "?") + " - " + (dStr || "?") + ")</small>";
                        }
                        
                        html += "<li class='mb-2 border-bottom pb-1'>" + label + details + 
                                " <div class='mt-1'>" +
                                " <button type='button' class='btn btn-sm btn-outline-primary' " +
                                "onclick='event.preventDefault(); event.stopPropagation(); window.datencheckShowComparison(\"" + (currentXref || "NEW") + "\", \"" + item.id2 + "\")'>" +
                                "<?= \Fisharebest\Webtrees\I18N::translate('Compare') ?></button>";
                        
                        if (item.families && item.families.length > 0) {
                            html += " <button type='button' class='btn btn-sm btn-outline-info ms-1' " +
                                    "onclick='event.preventDefault(); event.stopPropagation(); window.datencheckShowFamilyComparison(\"" + item.families[0] + "\")'>" +
                                    "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ " + "<?= \Fisharebest\Webtrees\I18N::translate('Compare Family') ?></button>";
                        }
                        
                        html += " <button type='button' class='btn btn-sm btn-outline-success ms-1' " +
                                  "onclick='event.preventDefault(); event.stopPropagation(); window.datencheckFillPerson(\"" + item.id2 + "\")'>" +
                                  "üë§ " + "<?= \Fisharebest\Webtrees\I18N::translate('Use this person') ?></button>";
                        
                        if (item.families && item.families.length > 0) {
                            html += " <button type='button' class='btn btn-sm btn-outline-danger ms-1' " +
                                    "onclick='event.preventDefault(); event.stopPropagation(); window.datencheckJoinFamily(\"" + item.families[0] + "\")'>" +
                                    "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ " + "<?= \Fisharebest\Webtrees\I18N::translate('Use this family') ?></button>";
                        }
                        
                        html += "</li>";

                        // NEW: If we found a duplicate person, and the OTHER spouse is already in the form, 
                        // check if they already have a family together.
                        const husbId = document.getElementById("HUSB")?.value || "";
                        const wifeId = document.getElementById("WIFE")?.value || "";
                        let otherSpouseId = "";
                        let testHusb = "";
                        let testWife = "";

                        if (husbId && !wifeId) { testHusb = husbId; testWife = item.id2; }
                        else if (!husbId && wifeId) { testHusb = item.id2; testWife = wifeId; }

                        if (testHusb && testWife) {
                            fetch("<?= $family_url ?>?husb=" + encodeURIComponent(testHusb) + "&wife=" + encodeURIComponent(testWife))
                                .then(r => r.json())
                                .then(famData => {
                                    if (famData.data && famData.data.length > 0) {
                                        showFamilyWarning(famData.data);
                                    }
                                });
                        }
                    });
                    html += "</ul>";
                    warningArea.innerHTML = html;
                    warningArea.style.display = "block";
                } else {
                    warningArea.style.display = "none";
                }
            });
    };

    const checkSibling = () => {
        const given = document.querySelector('[id$="-GIVN"]')?.value || "";
        const surname = document.querySelector('[id$="-SURN"]')?.value || "";
        const birth = document.querySelector('[id$="-INDI-BIRT-DATE"]')?.value || "";
        const husb = document.getElementById("HUSB")?.value || "";
        const wife = document.getElementById("WIFE")?.value || "";

        if ((!husb && !wife) || (given.length < 2 && surname.length < 2)) return;

        fetch("<?= $sibling_url ?>?husb=" + encodeURIComponent(husb) + "&wife=" + encodeURIComponent(wife) + "&child_given=" + encodeURIComponent(given) + "&child_surname=" + encodeURIComponent(surname) + "&child_birth=" + encodeURIComponent(birth))
            .then(response => response.json())
            .then(data => {
                let sibWarning = document.getElementById("datencheck-sib-warning");
                if (!sibWarning) {
                    sibWarning = document.createElement("div");
                    sibWarning.id = "datencheck-sib-warning";
                    sibWarning.className = "alert alert-danger mt-2";
                    sibWarning.style.display = "none";
                    const target = document.querySelector('[id*="INDI-NAME"]')?.closest(".card");
                    if (target) target.parentNode.insertBefore(sibWarning, target);
                }

                if (data.data && data.data.length > 0) {
                    let html = "<strong><?= \Fisharebest\Webtrees\I18N::translate('This person already exists as a child in this family:') ?></strong><ul class='list-unstyled'>";
                    data.data.forEach(item => {
                        html += "<li class='mb-2'>" + item.name2 + " (" + item.id2 + ")";
                        if (item.family_id) {
                            html += " <button type='button' class='btn btn-sm btn-outline-primary ms-1' onclick='window.datencheckShowFamilyComparison(\"" + item.family_id + "\")'>" +
                                    "<?= \Fisharebest\Webtrees\I18N::translate('Compare') ?></button>";
                            html += " <button type='button' class='btn btn-sm btn-outline-danger ms-1' onclick='window.datencheckJoinFamily(\"" + item.family_id + "\")'>" +
                                    "<?= \Fisharebest\Webtrees\I18N::translate('Use this family') ?></button>";
                        }
                        html += "</li>";
                    });
                    html += "</ul>";
                    sibWarning.innerHTML = html;
                    sibWarning.style.display = "block";
                } else {
                    sibWarning.style.display = "none";
                }
            });
    };

    const showFamilyWarning = (famIds) => {
        let famWarning = document.getElementById("datencheck-fam-warning");
        if (!famWarning) {
            famWarning = document.createElement("div");
            famWarning.id = "datencheck-fam-warning";
            famWarning.className = "alert alert-info mt-2";
            famWarning.style.display = "none";
            const target = document.querySelector("form[name='changefamform']") || 
                          document.querySelector("#HUSB")?.closest(".row") || 
                          document.querySelector("#WIFE")?.closest(".row") ||
                          document.getElementById("interactive-duplicate-warning");
            if (target) target.parentNode.insertBefore(famWarning, target);
        }

        if (famIds && famIds.length > 0) {
            let html = "<strong><?= \Fisharebest\Webtrees\I18N::translate('These parents already have a family:') ?></strong> " + famIds.join(", ");
            html += ' <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="window.datencheckShowFamilyComparison(\'' + famIds[0] + '\')"><?= \Fisharebest\Webtrees\I18N::translate('Compare') ?></button>';
            html += ' <button type="button" class="btn btn-sm btn-outline-primary ms-1" onclick="window.datencheckJoinFamily(\'' + famIds[0] + '\')"><?= \Fisharebest\Webtrees\I18N::translate('Use this family') ?></button>';
            famWarning.innerHTML = html;
            famWarning.style.display = "block";
        } else {
            famWarning.style.display = "none";
        }
    };

    const checkFamily = () => {
        const husb = document.getElementById("HUSB")?.value || "";
        const wife = document.getElementById("WIFE")?.value || "";

        if (!husb || !wife) return;

        fetch("<?= $family_url ?>?husb=" + encodeURIComponent(husb) + "&wife=" + encodeURIComponent(wife))
            .then(response => response.json())
            .then(data => {
                showFamilyWarning(data.data);
            });
    };

    window.datencheckJoinFamily = (famId) => {
        const cleanId = famId.replace(/@/g, '');
        const selectors = [
            'input[name="f"]', 'input[name="fam"]', 'input[name="fid"]', 'input[name="f_id"]',
            'input[name="family_id"]', '#f', '#fam', '#fid', '#f_id',
            'input[id*="FAM_ID"]', 'input[name*="FAM_ID"]'
        ];
        
        let found = false;
        for (const selector of selectors) {
            const el = document.querySelector(selector);
            if (el && (el.type === 'text' || el.type === 'hidden' || el.tagName === 'INPUT')) {
                el.value = cleanId;
                el.dispatchEvent(new Event('change', { bubbles: true }));
                el.dispatchEvent(new Event('input', { bubbles: true }));
                found = true;
                break;
            }
        }

        if (found) {
            const btn = event?.target;
            if (btn && btn.tagName === 'BUTTON') {
                const oldText = btn.innerHTML;
                btn.innerHTML = "‚úÖ <?= \Fisharebest\Webtrees\I18N::translate('Linked') ?>";
                btn.disabled = true;
                setTimeout(() => { btn.innerHTML = oldText; btn.disabled = false; }, 2000);
            }
            const warning = document.getElementById("datencheck-fam-warning");
            if (warning) warning.style.display = "none";
        } else {
            alert("<?= \Fisharebest\Webtrees\I18N::translate('Family input field not found. Please enter ID {ID} manually.') ?>".replace('{ID}', cleanId));
        }
    };

    window.datencheckFillPerson = (xref) => {
        const cleanId = xref.replace(/@/g, '');
        const selectors = [
            'input[name="indi"]', 'input[name="xref"]', 'input[name="indi1"]', 'input[name="indi2"]',
            'input[name="p1"]', 'input[name="p2"]', 'input[name="child"]',
            'input[name*="INDI"]', 'input[id*="INDI"]', 'input[id*="HUSB"]', 'input[id*="WIFE"]',
            'input[id*="FATH"]', 'input[id*="MOTH"]', 'input[name*="XREF"]',
            'input.indi-search'
        ];
        
        let found = false;
        for (const selector of selectors) {
            const el = document.querySelector(selector);
            if (el && (el.type === 'text' || el.type === 'hidden' || el.tagName === 'INPUT')) {
                el.value = cleanId;
                el.dispatchEvent(new Event('change', { bubbles: true }));
                el.dispatchEvent(new Event('input', { bubbles: true })); 
                found = true;
                break;
            }
        }

        if (!found) {
            alert("<?= \Fisharebest\Webtrees\I18N::translate('Person input field not found. Please enter ID {ID} manually.') ?>".replace('{ID}', cleanId));
        }
    };

    // Helper to ensure modal exists and return it
    function ensureModal() {
        let modal = document.getElementById("datencheck-comparison-modal");
        if (!modal) {
            modal = document.createElement("div");
            modal.id = "datencheck-comparison-modal";
            modal.className = "modal fade";
            modal.tabIndex = -1;
            modal.innerHTML = "<div class='modal-dialog modal-xl'>" +
                "<div class='modal-content'>" +
                    "<div class='modal-header'>" +
                        "<h5 class='modal-title' id='datencheck-modal-title'><?= \Fisharebest\Webtrees\I18N::translate('Comparison') ?></h5>" +
                        "<button type='button' class='btn-close' data-bs-dismiss='modal'></button>" +
                    "</div>" +
                    "<div class='modal-body'>" +
                        "<div class='row'>" +
                            "<div class='col-md-6'>" +
                                "<h6 class='text-primary' id='datencheck-modal-left-label'><?= \Fisharebest\Webtrees\I18N::translate('Current Entry') ?></h6>" +
                                "<div id='comparison-current' class='border rounded p-3' style='min-height: 100px;'>" +
                                    "<div class='text-center text-muted py-4'>" +
                                        "<div class='spinner-border spinner-border-sm' role='status'></div>" +
                                        " <?= \Fisharebest\Webtrees\I18N::translate('Loading data...') ?>" +
                                    "</div>" +
                                "</div>" +
                            "</div>" +
                            "<div class='col-md-6'>" +
                                "<h6 class='text-warning' id='datencheck-modal-right-label'><?= \Fisharebest\Webtrees\I18N::translate('Possible Duplicate') ?></h6>" +
                                "<div id='comparison-duplicate' class='border rounded p-3' style='min-height: 100px;'>" +
                                    "<div class='text-center text-muted py-4'>" +
                                        "<div class='spinner-border spinner-border-sm' role='status'></div>" +
                                        " <?= \Fisharebest\Webtrees\I18N::translate('Loading data...') ?>" +
                                    "</div>" +
                                "</div>" +
                            "</div>" +
                        "</div>" +
                    "</div>" +
                    "<div class='modal-footer d-flex justify-content-between'>" +
                        "<a href='#' id='comparison-open-btn' target='_blank' class='btn btn-outline-primary'><?= \Fisharebest\Webtrees\I18N::translate('Open in new window ‚ÜóÔ∏è') ?></a>" +
                        "<div>" +
                            "<button type='button' id='comparison-use-person-btn' class='btn btn-success' style='display:none;' onclick='window.datencheckFillPerson(this.dataset.xref)'>üë§ <?= \Fisharebest\Webtrees\I18N::translate('Use this person') ?></button>" +
                            "<button type='button' id='comparison-use-family-btn' class='btn btn-danger ms-1' style='display:none;' onclick='window.datencheckJoinFamily(this.dataset.fam)'>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ <?= \Fisharebest\Webtrees\I18N::translate('Use this family') ?></button>" +
                            "<button type='button' class='btn btn-secondary ms-1' data-bs-dismiss='modal'><?= \Fisharebest\Webtrees\I18N::translate('Close') ?></button>" +
                        "</div>" +
                    "</div>" +
                "</div>" +
            "</div>";
            document.body.appendChild(modal);
        }
        return modal;
    }

    // Comparison Modal Functions
    window.datencheckShowComparison = (currentXref, duplicateXref) => {
        const modal = ensureModal();
        
        // Reset and set title
        document.getElementById("datencheck-modal-title").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Person Comparison') ?>";
        document.getElementById("datencheck-modal-left-label").className = "text-primary";
        document.getElementById("datencheck-modal-left-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Current Entry') ?>";
        document.getElementById("datencheck-modal-right-label").className = "text-warning";
        document.getElementById("datencheck-modal-right-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Possible Duplicate') ?>";
        
        const loadingHtml = "<div class='text-center text-muted py-4'><div class='spinner-border spinner-border-sm' role='status'></div> <?= \Fisharebest\Webtrees\I18N::translate('Loading data...') ?></div>";
        document.getElementById("comparison-current").innerHTML = loadingHtml;
        document.getElementById("comparison-duplicate").innerHTML = loadingHtml;

        // Header IDs
        document.getElementById("datencheck-modal-left-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Current Entry') ?>";
        document.getElementById("datencheck-modal-right-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Possible Duplicate') ?> " + (duplicateXref ? "[" + duplicateXref + "]" : "");

        const openBtn = document.getElementById("comparison-open-btn");
        if (openBtn) {
            openBtn.href = "<?= $individual_url ?>".replace("I1", duplicateXref);
            openBtn.style.display = "inline-block";
        }
        
        // Reset Use buttons
        document.getElementById("comparison-use-person-btn").style.display = "none";
        document.getElementById("comparison-use-family-btn").style.display = "none";

        const fetchDuplicate = fetch(("<?= $details_url ?>".includes("?") ? "<?= $details_url ?>&xref=" : "<?= $details_url ?>?xref=") + encodeURIComponent(duplicateXref)).then(r => r.json());
        
        // Handle Current Side: Fetch if XREF exists, otherwise use form data
        let fetchCurrent;
        if (currentXref && currentXref !== "NEW") {
            fetchCurrent = fetch(("<?= $details_url ?>".includes("?") ? "<?= $details_url ?>&xref=" : "<?= $details_url ?>?xref=") + encodeURIComponent(currentXref)).then(r => r.json());
        } else {
            // "Mock" the data from the form
            fetchCurrent = Promise.resolve(getFormDataAsDetails());
        }

        // Fetch data for both persons
        Promise.all([fetchCurrent, fetchDuplicate]).then(([currentData, duplicateData]) => {
            populateComparison(currentData, duplicateData);
            
            // Show use-person button
            const useBtn = document.getElementById("comparison-use-person-btn");
            if (useBtn && duplicateData.xref) {
                useBtn.dataset.xref = duplicateData.xref;
                useBtn.style.display = "inline-block";
            }
        }).catch(err => {
            console.error("Datencheck: Comparison fetch failed", err);
            document.getElementById("comparison-current").innerHTML = "<div class='alert alert-danger'><?= \Fisharebest\Webtrees\I18N::translate('Error loading') ?></div>";
            document.getElementById("comparison-duplicate").innerHTML = "<div class='alert alert-danger'><?= \Fisharebest\Webtrees\I18N::translate('Error loading') ?></div>";
        });

        // Show modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    };

    window.datencheckShowFamilyComparison = (famId) => {
        const modal = ensureModal();
        
        // Use proper connector for URL
        const connector = "<?= $family_details_url ?>".includes("?") ? "&" : "?";
        const url = "<?= $family_details_url ?>" + connector + "fam=" + encodeURIComponent(famId);

        // UI Setup
        document.getElementById("datencheck-modal-title").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Family Comparison') ?>";
        document.getElementById("datencheck-modal-left-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Current Form Data') ?>";
        document.getElementById("datencheck-modal-right-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Existing Family') ?>";
        
        const loadingHtml = "<div class='text-center text-muted py-4'><div class='spinner-border spinner-border-sm' role='status'></div> <?= \Fisharebest\Webtrees\I18N::translate('Loading data...') ?></div>";
        document.getElementById("comparison-current").innerHTML = loadingHtml;
        document.getElementById("comparison-duplicate").innerHTML = loadingHtml;
        
        // Hide "Open in new window" for families for now
        document.getElementById("comparison-open-btn").style.display = "none";
        document.getElementById("comparison-use-person-btn").style.display = "none";
        document.getElementById("comparison-use-family-btn").style.display = "none";

        const currentData = getFamilyFormData();
        
        // Show Family IDs in Headers
        document.getElementById("datencheck-modal-left-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Current Entry') ?> " + (currentData.famXref ? "[" + currentData.famXref + "]" : "[NEW]");
        document.getElementById("datencheck-modal-right-label").innerText = "<?= \Fisharebest\Webtrees\I18N::translate('Possible Duplicate') ?> [" + famId + "]";

        document.getElementById("comparison-current").innerHTML = formatFamilyDetails(currentData);
        updateComparisonNames(currentData);

        fetch(url)
            .then(r => r.json())
            .then(duplicateData => {
                document.getElementById("comparison-duplicate").innerHTML = formatFamilyDetails(duplicateData);
                
                // Show use-family button
                const useBtn = document.getElementById("comparison-use-family-btn");
                if (useBtn && famId) {
                    useBtn.dataset.fam = famId;
                    useBtn.style.display = "inline-block";
                }
            })
            .catch(err => {
                console.error("Datencheck: Family comparison failed", err);
                document.getElementById("comparison-duplicate").innerHTML = "<div class='alert alert-danger'><?= \Fisharebest\Webtrees\I18N::translate('Error loading') ?></div>";
            });

        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    };

    function getFamilyFormData() {
        // Try various common IDs for husband and wife in webtrees forms
        const husbInput = document.getElementById("HUSB") || document.querySelector('input[name="husb"]') || document.querySelector('input[name="indi1"]');
        const wifeInput = document.getElementById("WIFE") || document.querySelector('input[name="wife"]') || document.querySelector('input[name="indi2"]');
        
        let husbXref = isXref(husbInput?.value) ? husbInput.value.replace(/@/g, '') : "";
        let wifeXref = isXref(wifeInput?.value) ? wifeInput.value.replace(/@/g, '') : "";
        let childXref = "";
        let famXref = "";

        const findName = (role) => {
            // Check for search descriptors webtrees uses, specific to the role
            const container = document.querySelector('.indi-search[data-role="' + role + '"]')?.closest('.row, .form-group, td') ||
                             document.querySelector('[id*="' + role + '"]')?.closest('.row, .form-group, td');
            
            if (container) {
                const nameEl = container.querySelector('.name, .full-name, .text-muted:not(small)') || 
                               container.querySelector('span:not(.btn-group):not(.indi-search)');
                
                let text = nameEl ? nameEl.innerText : container.innerText;
                // Clean up technical labels and search buttons
                text = text.replace(/Select|Clear|Suchen|L√∂schen|Alter der .+|Hinzuf√ºgen/gi, "").split('(')[0].trim();
                text = text.replace(/^(Ehefrau|Ehemann|Husband|Wife|Mutter|Vater|Mother|Father|Elternteil):\s*/i, "");
                if (text.toLowerCase().includes("alter der")) return "";
                return text.length > 1 ? text : "";
            }
            return "";
        };

        const currentUrl = decodeURIComponent(window.location.href);
        const urlParams = new URLSearchParams(window.location.search);
        
        // Find ALL strings that look like Xrefs (X123, I123, F123)
        const allXrefs = [...new Set(currentUrl.match(/[IXF]\d+/g) || [])];
        console.log("Datencheck Debug: All URL Xrefs found:", allXrefs);

        // Identify the "Main" individual of the current page path
        const mainIndiMatch = currentUrl.match(/\/individual\/([IXF]\d+)/) || 
                             currentUrl.match(/[?&](?:xref|id|indiv)=([IXF]\d+)/);
        const mainPerson = mainIndiMatch ? mainIndiMatch[1] : null;
        
        allXrefs.forEach(xref => {
            const clean = xref.replace(/@/g, '');
            if (clean === mainPerson) {
                childXref = clean;
            } else if (!famXref && (clean.startsWith('F') || allXrefs.length > 1)) {
                // If it's NOT the main person and there are multiple IDs, 
                // the other one is highly likely the family context (even if it starts with X)
                famXref = clean;
            }
        });

        // Special case: if we only found ONE ID and it's not the main person, 
        // it might be the family (e.g. X14)
        if (!famXref && allXrefs.length === 1 && allXrefs[0] !== mainPerson) {
            famXref = allXrefs[0];
        } else if (!childXref && mainPerson) {
            childXref = mainPerson;
        }

        // Final sanity check: swap if misidentified
        if (childXref && childXref.startsWith('F') && !famXref) {
            famXref = childXref;
            childXref = "";
        }

        console.log("Datencheck Debug: Context IDs - Child:", childXref, "Family:", famXref, "Main:", mainPerson);

        let husbName = findName("HUSB");
        let wifeName = findName("WIFE");

        // Current form names (GIVN / SURN) being entered right now
        const formGiven = document.querySelector('[id*="GIVN"]')?.value || "";
        const formSurname = document.querySelector('[id*="SURN"]')?.value || "";
        const formFullName = (formGiven || formSurname) ? (formGiven + " /" + formSurname + "/").trim() : "";

        const formBirth = document.querySelector('[id*="BIRT"][id*="DATE"]')?.value || "";
        const formDeath = document.querySelector('[id*="DEAT"][id*="DATE"]')?.value || "";
        const formBirthPlac = document.querySelector('[id*="BIRT"][id*="PLAC"]')?.value || "";
        const formDeathPlac = document.querySelector('[id*="DEAT"][id*="PLAC"]')?.value || "";
        
        // Extract years for summary
        const getYear = (d) => {
            if (!d) return "";
            const match = d.match(/\d{4}/);
            return match ? match[0] : "?";
        };
        const formDates = (getYear(formBirth) || getYear(formDeath)) ? (getYear(formBirth) || "?") + " - " + (getYear(formDeath) || "?") : "";
        const formDetails = { birth: { date: formBirth, place: formBirthPlac }, death: { date: formDeath, place: formDeathPlac } };

        // Determine sex: check form input, then URL
        let sexInput = document.querySelector('select[id*="SEX"], input[name*="SEX"]:checked')?.value || "";
        if (!sexInput) {
            const urlSex = new URLSearchParams(window.location.search).get('sex');
            if (urlSex) sexInput = urlSex.toUpperCase();
        }
        // If we are on an "Add Mother" or "Add Wife" page, sex is implicitly F
        if (!sexInput) {
            if (window.location.href.includes("mother") || window.location.href.includes("wife") || document.title.toLowerCase().includes("mutter") || document.title.toLowerCase().includes("ehefrau")) {
                sexInput = "F";
            } else if (window.location.href.includes("father") || window.location.href.includes("husband") || document.title.toLowerCase().includes("vater") || document.title.toLowerCase().includes("ehemann")) {
                sexInput = "M";
            }
        }
        
        let husbDates = "";
        let wifeDates = "";
        let dataUpdateHusb = null;
        let dataUpdateWife = null;

        // If we have a form name, it belongs to the person with the matching sex
        if (formFullName) {
            if (sexInput === "M") { 
                husbName = formFullName; 
                husbDates = formDates; 
                husbXref = "NEW"; 
                dataUpdateHusb = formDetails;
            } else if (sexInput === "F") { 
                wifeName = formFullName; 
                wifeDates = formDates; 
                wifeXref = "NEW"; 
                dataUpdateWife = formDetails;
            }
        }

        // Fallback: if adding to an existing person (e.g. "Add a wife to Hans Meier")
        if (!husbName && husbXref) husbName = husbXref;
        if (!wifeName && wifeXref) wifeName = wifeXref;

        const getMarrValue = (subtag) => {
            const pattern = subtag.toUpperCase();
            const altPattern = (subtag === "PLAC" || subtag === "PLACE") ? ["PLAC", "PLACE", "ORT", "LIEU"] : ["DATE", "DATUM", "TAG", "MONAT", "JAHR"];
            
            // 1. Spezifische webtrees 2.2.x Familien-Felder (h√∂chste Priorit√§t)
            const prefId = `f_marr_${subtag.toLowerCase()}`;
            const prefEl = document.getElementById(prefId) || document.querySelector(`[name="${prefId}"]`);
            if (prefEl && prefEl.value) return prefEl.value;

            const translatedMarr = "<?= \Fisharebest\Webtrees\I18N::translate('Marriage') ?>";
            const translatedMarrLower = translatedMarr.toLowerCase();
            
            // 2. Suche in webtrees Fact-Containern (tr-MARR etc.)
            const factContainers = document.querySelectorAll('.wt-fact-container, .fact-item, .tr-MARR, .tr-MAR_, .tr-MAR_TAG, .fact-MARR');
            for (let container of factContainers) {
                const header = (container.innerText || "").toLowerCase();
                // Pr√ºfe auf Heirats-Begriffe in verschiedenen Sprachen
                if (header.includes(translatedMarrLower) || header.match(/heirat|marriage|mariage|matrimonio|brak|trouwen|hochzeit|verm√§|ehesch/i)) {
                    // Suche gezielt nach dem passenden Input innerhalb dieses Containers
                    const inputs = container.querySelectorAll('input, select, textarea');
                    for (let input of inputs) {
                        const searchStr = (input.id + " " + input.name).toUpperCase();
                        if (altPattern.some(p => searchStr.includes(p)) && input.value) return input.value;
                    }
                    // Schlechtester Fall: Einfach den ersten Input im Container nehmen
                    if (inputs.length > 0 && inputs[0].value && !inputs[0].id.includes('SOUR')) return inputs[0].value;
                }
            }

            // 3. Globaler Scan aller Inputs nach MARR
            const allInputs = document.querySelectorAll('input, select, textarea');
            for (let input of allInputs) {
                const search = (input.id + " " + input.name + " " + (input.placeholder || "")).toUpperCase();
                if (search.includes("MARR") || search.includes("MARRIAGE") || search.includes("HEIRAT")) {
                    if (altPattern.some(p => search.includes(p)) && input.value) return input.value;
                }
            }

            // 4. Letzter Versuch: Suche nach Labels im DOM und nimm benachbarte Inputs
            const labels = document.querySelectorAll('label, span, th, td');
            for (let label of labels) {
                const text = (label.innerText || "").toLowerCase();
                if (text.includes(translatedMarrLower) || text.match(/heirat|marriage|hochzeit/i)) {
                    const parent = label.closest('tr, .form-group, .row, .wt-fact-container, div');
                    if (parent) {
                        const input = parent.querySelector('input') || parent.querySelector('select');
                        if (input && input.value) return input.value;
                    }
                }
            }
            
            return "";
        };

        const marrDate = getMarrValue("DATE");
        const marrPlace = getMarrValue("PLAC");

        // If we are adding a parent to a child, find the child
        let children = [];

        const getFieldValue = (name) => {
            let val = urlParams.get(name);
            if (isXref(val)) return val.replace(/@/g, '');
            
            const el = document.querySelector('input[name="' + name + '"]') ||
                      document.querySelector('input[id="' + name + '"]') ||
                      document.querySelector('input[id*="' + name.toUpperCase() + '"]') ||
                      document.getElementById(name);
            
            val = el?.value || "";
            return isXref(val) ? val.replace(/@/g, '') : "";
        };

        if (!childXref) {
            childXref = getFieldValue('parent_of') || 
                         getFieldValue('child') || 
                         getFieldValue('child_id') || 
                         getFieldValue('indi_id') ||
                         getFieldValue('spawn_indi') || 
                         getFieldValue('p1') || 
                         getFieldValue('p2') ||
                         getFieldValue('spawn_id');
        }

        if (!famXref) {
            famXref = getFieldValue('fam') || 
                      getFieldValue('f') || 
                      getFieldValue('fam_id') || 
                      getFieldValue('family_id') || 
                      getFieldValue('fid') || 
                      getFieldValue('f_id');
        }

        // Deep Scan fallback for data-xref / data-fid
        if (!childXref) {
            const xrefEl = document.querySelector('[data-xref]');
            if (xrefEl && isXref(xrefEl.dataset.xref)) childXref = xrefEl.dataset.xref.replace(/@/g, '');
        }
        if (!famXref) {
            const fidEl = document.querySelector('[data-fid]') || document.querySelector('[data-family-id]');
            if (fidEl && isXref(fidEl.dataset.fid || fidEl.dataset.familyId)) famXref = (fidEl.dataset.fid || fidEl.dataset.familyId).replace(/@/g, '');
        }

        // Contextual IDs from form fields (often webtrees uses parent1/parent2)
        const p1 = getFieldValue('parent1') || getFieldValue('husb') || getFieldValue('indi1');
        const p2 = getFieldValue('parent2') || getFieldValue('wife') || getFieldValue('indi2');
        
        if (isXref(p1) && (!husbXref || husbXref === "NEW" || husbXref === "")) husbXref = p1.replace(/@/g, '');
        if (isXref(p2) && (!wifeXref || wifeXref === "NEW" || wifeXref === "")) wifeXref = p2.replace(/@/g, '');

        if (!childXref || !isXref(childXref)) {
            for (const [key, value] of urlParams.entries()) {
                const cleanVal = value.replace(/@/g, '');
                if (isXref(cleanVal) && cleanVal !== husbXref && cleanVal !== wifeXref && !cleanVal.startsWith('F')) {
                    childXref = cleanVal;
                    break;
                }
            }
        }
        if (!famXref || !isXref(famXref)) {
            for (const [key, value] of urlParams.entries()) {
                const cleanVal = value.replace(/@/g, '');
                // Relax F prefix if key is definitely family related
                if (isXref(cleanVal) && (cleanVal.startsWith('F') || key === 'f' || key === 'fam' || key === 'fid')) {
                    famXref = cleanVal;
                    break;
                }
            }
        }

        
        console.log("Datencheck Debug: Role Assessment - Husband:", husbXref, "Wife:", wifeXref, "Child:", childXref, "Family:", famXref);

        if (childXref && childXref.match(/^[IXF]\d+$/)) {
            children.push({ xref: childXref, name: "...", dates: "" });
        }

        const result = {
            husband: { xref: husbXref || "NEW", name: husbName || "---", dates: husbDates },
            wife: { xref: wifeXref || "NEW", name: wifeName || "---", dates: wifeDates },
            marriage: { date: marrDate, place: marrPlace },
            famXref: famXref,
            children: children 
        };

        if (dataUpdateHusb) Object.assign(result.husband, dataUpdateHusb);
        if (dataUpdateWife) Object.assign(result.wife, dataUpdateWife);

        return result;
    }

    function formatPerson(p) {
        if (!p || (!p.name && !p.xref)) return "---";
        
        const shortPlace = (pl) => {
            if (!pl) return "";
            return pl.split(',')[0].trim();
        };

        let res = (p.name || "---").replace(/\//g, "");
        if (p.dates) res += " <small class='text-muted'>(" + p.dates + ")</small>";
        
        let sublines = [];
        if (p.birth?.place) sublines.push("* " + shortPlace(p.birth.place));
        if (p.death?.place) sublines.push("‚Ä† " + shortPlace(p.death.place));
        
        if (sublines.length > 0) {
            res += "<br><small class='text-muted' style='font-size:0.8rem; line-height: 1.1; display: inline-block;'>" + sublines.join("<br>") + "</small>";
        }
        
        res += " <small class='text-secondary'>[" + p.xref + "]</small>";
        return res;
    }

    function updateComparisonNames(data) {
        let container = document.getElementById("comparison-current");
        if (!container) return;
        
        console.log("Datencheck: updateComparisonNames starting for", data);

        const fetchAndShow = (xref, type, childXref = null) => {
            if (!isXref(xref) || xref === "NEW") return;
            console.log("Datencheck: Fetching details for " + type + " (" + xref + ")");
            
            fetch("<?= $details_url ?>".includes("?") ? "<?= $details_url ?>&xref=" + xref : "<?= $details_url ?>?xref=" + xref)
                .then(r => r.json())
                .then(d => {
                    if (d.error && d.error.includes("nicht gefunden")) {
                        console.log("Datencheck: Individual " + xref + " not found, checking if it is a family...");
                        if (!data.famXref) {
                            data.famXref = xref;
                            updateComparisonNames(data);
                        }
                        return;
                    }
                    
                    console.log("Datencheck: Success labels for " + xref, d);
                    if (type === 'child' && childXref) {
                        const li = container.querySelector("li[data-xref='" + d.xref + "']");
                        if (li) {
                            li.innerHTML = formatPerson(d);
                        }
                    } else if (type === 'husband' || type === 'wife') {
                        // Find the specific container for husband or wife
                        const divs = container.querySelectorAll("div.mb-2, div.mb-0");
                        for (let div of divs) {
                            const label = div.querySelector('strong')?.innerText || "";
                            if ((type === 'husband' && (label.includes("Husband") || label.includes("Ehemann"))) ||
                                (type === 'wife' && (label.includes("Wife") || label.includes("Ehefrau")))) {
                                div.innerHTML = "<strong>" + label + "</strong><br>" + formatPerson(d);
                                break;
                            }
                        }
                    }
                }).catch(e => console.error("Datencheck: Fetch failed for " + xref, e));
        };

        const fetchFullIndividualMetadata = (xref) => {
            if (!isXref(xref) || xref === "NEW" || data._metadataFetched === xref) return;
            data._metadataFetched = xref; 
            
            console.log("Datencheck: Proactively fetching metadata for " + xref);
            fetch("<?= $details_url ?>".includes("?") ? "<?= $details_url ?>&xref=" + xref : "<?= $details_url ?>?xref=" + xref)
                .then(r => r.json())
                .then(d => {
                    if (d.error) return;
                    let changed = false;
                    
                    if (d.parents && d.parents.length > 0) {
                        console.log("Datencheck: Found " + d.parents.length + " parents via child " + xref);
                        if (!isXref(data.husband.xref) || data.husband.xref === 'NEW') {
                            if (d.parents[0].xref !== data.wife.xref) {
                                Object.assign(data.husband, d.parents[0]);
                                changed = true;
                            }
                        }
                        if (d.parents.length > 1 && (!isXref(data.wife.xref) || data.wife.xref === 'NEW')) {
                            if (d.parents[1].xref !== data.husband.xref) {
                                Object.assign(data.wife, d.parents[1]);
                                changed = true;
                            }
                        }
                    } else if (d.families && d.families.length > 0) {
                        console.log("Datencheck: Found " + d.families.length + " families via spouse " + xref);
                        const fam = d.families[0];
                        if (fam.husband && (!isXref(data.husband.xref) || data.husband.xref === 'NEW')) {
                            if (fam.husband.xref !== data.wife.xref) {
                                Object.assign(data.husband, fam.husband);
                                changed = true;
                            }
                        }
                        if (fam.wife && (!isXref(data.wife.xref) || data.wife.xref === 'NEW')) {
                            if (fam.wife.xref !== data.husband.xref) {
                                Object.assign(data.wife, fam.wife);
                                changed = true;
                            }
                        }
                        if (fam.children && fam.children.length > 0) {
                            fam.children.forEach(c => {
                                if (!data.children.find(dc => dc.xref === c.xref)) {
                                    data.children.push(c);
                                    changed = true;
                                }
                            });
                        }
                    }
                    
                    if (changed) {
                        // Prevent cross-talk: if husband and wife became same, and we have family, trust family
                        if (data.husband.xref === data.wife.xref && isXref(data.husband.xref)) {
                             // This usually happens if d.parents only had one item or metadata was circular
                        }
                        container.innerHTML = formatFamilyDetails(data);
                        updateComparisonNames(data);
                    }
                });
        };

        // If we have a family XREF, fetch children
        if (data.famXref && data._famFetched !== data.famXref) {
            data._famFetched = data.famXref;
            console.log("Datencheck: Fetching family members for " + data.famXref);
            const connector = "<?= $family_details_url ?>".includes("?") ? "&" : "?";
            fetch("<?= $family_details_url ?>" + connector + "fam=" + encodeURIComponent(data.famXref))
                .then(r => r.json())
                .then(famData => {
                    if (famData.error) return;
                    console.log("Datencheck: Family members received for " + data.famXref, famData);
                    let changed = false;
                    
                    // Trust family structure ALWAYS over heuristics
                    if (famData.husband) {
                        Object.assign(data.husband, famData.husband);
                        changed = true;
                    }
                    if (famData.wife) {
                        Object.assign(data.wife, famData.wife);
                        changed = true;
                    }
                    if (famData.marriage) {
                        console.log("Datencheck: Merging marriage data", {current: data.marriage, server: famData.marriage});
                        // Prioritize form data (already in 'data') over server data
                        // Only fill in if the form data was empty
                        if (!data.marriage.date && famData.marriage.date) {
                            console.log("Datencheck: Updating date from server: " + famData.marriage.date);
                            data.marriage.date = famData.marriage.date;
                            changed = true;
                        }
                        if (!data.marriage.place && famData.marriage.place) {
                            console.log("Datencheck: Updating place from server: " + famData.marriage.place);
                            data.marriage.place = famData.marriage.place;
                            changed = true;
                        }
                    }
                    if (famData.children && famData.children.length > 0) {
                        famData.children.forEach(c => {
                            if (!data.children.find(dc => dc.xref === c.xref)) {
                                data.children.push(c);
                                changed = true;
                            }
                        });
                    }
                    
                    if (changed) {
                        container.innerHTML = formatFamilyDetails(data);
                        updateComparisonNames(data);
                    }
                });
        }

        // Auto-lookup if spouses are missing
        const husbEmpty = !isXref(data.husband.xref) || data.husband.xref === 'NEW';
        const wifeEmpty = !isXref(data.wife.xref) || data.wife.xref === 'NEW';
        
        if (husbEmpty && wifeEmpty && data.children.length > 0) {
            fetchFullIndividualMetadata(data.children[0].xref);
        } else if (husbEmpty || wifeEmpty) {
            const anyXref = isXref(data.husband.xref) ? data.husband.xref : (isXref(data.wife.xref) ? data.wife.xref : null);
            if (anyXref && anyXref !== 'NEW') fetchFullIndividualMetadata(anyXref);
        }

        // Fetch labels for known individuals that need them
        if (isXref(data.husband.xref) && data.husband.xref !== 'NEW' && (!data.husband.name || data.husband.name === '---' || data.husband.name === data.husband.xref)) fetchAndShow(data.husband.xref, 'husband');
        if (isXref(data.wife.xref) && data.wife.xref !== 'NEW' && (!data.wife.name || data.wife.name === '---' || data.wife.name === data.wife.xref)) fetchAndShow(data.wife.xref, 'wife');
        data.children.forEach(c => {
            if (c.name === "...") fetchAndShow(c.xref, 'child', c.xref);
        });
    }

    function formatFamilyDetails(data) {
        let html = "<div class='family-details'>";
        
        // Oberer Bereich: Eltern links, Heirat rechts
        html += "<div class='d-flex justify-content-between align-items-start border-bottom pb-2 mb-2' style='min-height: 80px;'>";
        
        // Linke Seite: Eheleute
        html += "<div style='flex: 1;'>";
        html += "<div class='mb-2'><strong><?= \Fisharebest\Webtrees\I18N::translate('Husband:') ?></strong><br>" + formatPerson(data.husband) + "</div>";
        html += "<div class='mb-0'><strong><?= \Fisharebest\Webtrees\I18N::translate('Wife:') ?></strong><br>" + formatPerson(data.wife) + "</div>";
        html += "</div>";
        
        // Rechte Seite: Heirat (wie in Skizze)
        if (data.marriage && (data.marriage.date || data.marriage.place)) {
            html += "<div class='text-end ps-3 pt-1' style='min-width: 140px; border-left: 1px solid #eee;'>";
            html += "<div class='text-primary fw-bold' style='font-size: 1.1rem; margin-bottom: 2px;'>‚àû " + "<?= \Fisharebest\Webtrees\I18N::translate('Marriage') ?>" + "</div>";
            if (data.marriage.date) {
                html += "<div class='small fw-bold'>" + data.marriage.date + "</div>";
            }
            if (data.marriage.place) {
                const shortMarrPlace = data.marriage.place.split(',')[0].trim();
                html += "<div class='text-muted small' style='line-height: 1.2;'>" + shortMarrPlace + "</div>";
            }
            html += "</div>";
        } else {
            // Platzhalter f√ºr Heirat, falls nichts bekannt ist, um das Layout stabil zu halten
            html += "<div class='text-end ps-3 pt-1 text-muted small' style='min-width: 140px; opacity: 0.5;'>";
            html += "<em><?= \Fisharebest\Webtrees\I18N::translate('No marriage data') ?></em>";
            html += "</div>";
        }
        
        html += "</div>"; // Ende d-flex

        // Kinder Bereich
        html += "<div class='mt-2'><strong><?= \Fisharebest\Webtrees\I18N::translate('Children:') ?></strong><ul class='list-unstyled shadow-none p-0 mt-1' style='margin-left: 0;'>";
        if (data.children && data.children.length > 0) {
            data.children.forEach(c => {
                html += "<li data-xref='" + c.xref + "' class='border-bottom py-1'>" + formatPerson(c) + "</li>";
            });
        } else {
            html += "<li class='text-muted italic py-1'><em><?= \Fisharebest\Webtrees\I18N::translate('None') ?></em></li>";
        }
        html += "</ul></div></div>";
        return html;
    }

    function getFormDataAsDetails() {
        const getVal = (factType, subtag) => {
            const pattern = subtag.toUpperCase();
            const translatedLabel = factType === 'BIRT' ? 
                                    "<?= \Fisharebest\Webtrees\I18N::translate('Birth') ?>" : 
                                    "<?= \Fisharebest\Webtrees\I18N::translate('Death') ?>";
            
            // 1. Suche Fact-Container (z.B. Geburt/Death)
            const containers = document.querySelectorAll('.wt-fact-container, .fact-item, .tr-' + factType);
            for (let c of containers) {
                const text = c.innerText || "";
                if (text.includes(translatedLabel) || text.match(new RegExp(factType === 'BIRT' ? 'Geburt|Birth|Naissance' : 'Tod|Death|D√©c√®s', 'i'))) {
                    const input = c.querySelector(`input[id*="${pattern}"], input[name*="${pattern}"]`);
                    if (input) return input.value;
                }
            }
            // 2. Fallback: Direkte Suche nach Kombination
            return document.querySelector(`[id*="${factType}"][id*="${pattern}"]`)?.value || 
                   document.querySelector(`input[name*="${factType}"][name*="${pattern}"]`)?.value || 
                   document.querySelector(`[id*="${pattern}"]`)?.value || "";
        };

        const given = document.querySelector('[id*="GIVN"]')?.value || "";
        const surname = document.querySelector('[id*="SURN"]')?.value || "";
        
        const birthDate = getVal("BIRT", "DATE");
        const birthPlace = getVal("BIRT", "PLAC") || getVal("BIRT", "PLACE");
        const deathDate = getVal("DEAT", "DATE");
        const deathPlace = getVal("DEAT", "PLAC") || getVal("DEAT", "PLACE");

        return {
            name: (given + " /" + surname + "/").trim(),
            birth: { date: birthDate, place: birthPlace },
            death: { date: deathDate, place: deathPlace },
            parents: [],
            families: [],
            xref: "NEW"
        };
    }

    function populateComparison(currentData, duplicateData) {
        document.getElementById("comparison-current").innerHTML = formatPersonDetails(currentData);
        document.getElementById("comparison-duplicate").innerHTML = formatPersonDetails(duplicateData);
        highlightDifferences();
    }

    function formatPersonDetails(data) {
        if (data.error) {
            return "<div class='alert alert-danger'>" + data.error + "</div>";
        }

        let html = "<div class='person-details'>";
        
        // Name
        html += "<div class='mb-3' data-field='name'><strong><?= \Fisharebest\Webtrees\I18N::translate('Name:') ?></strong><br>" + (data.name || "<em class='text-muted'><?= \Fisharebest\Webtrees\I18N::translate('Not specified') ?></em>") + "</div>";
        
        // Birth
        html += "<div class='mb-3' data-field='birth'><strong><?= \Fisharebest\Webtrees\I18N::translate('Birth:') ?></strong><br>";
        if (data.birth && (data.birth.date || data.birth.place)) {
            if (data.birth.date) html += data.birth.date + "<br>";
            if (data.birth.place) html += "<small class='text-muted'>" + data.birth.place + "</small>";
        } else {
            html += "<em class='text-muted'><?= \Fisharebest\Webtrees\I18N::translate('Not specified') ?></em>";
        }
        html += "</div>";
        
        // Death
        html += "<div class='mb-3' data-field='death'><strong><?= \Fisharebest\Webtrees\I18N::translate('Death:') ?></strong><br>";
        if (data.death && (data.death.date || data.death.place)) {
            if (data.death.date) html += data.death.date + "<br>";
            if (data.death.place) html += "<small class='text-muted'>" + data.death.place + "</small>";
        } else {
            html += "<em class='text-muted'><?= \Fisharebest\Webtrees\I18N::translate('Not specified') ?></em>";
        }
        html += "</div>";
        
        // Parents
        html += "<div class='mb-3' data-field='parents'><strong><?= \Fisharebest\Webtrees\I18N::translate('Parents:') ?></strong><br>";
        if (data.parents && data.parents.length > 0) {
            html += "<ul class='list-unstyled mb-0'>";
            data.parents.forEach(parent => {
                html += "<li>" + parent.name + " (" + parent.xref + ")</li>";
            });
            html += "</ul>";
        } else {
            html += "<em class='text-muted'><?= \Fisharebest\Webtrees\I18N::translate('Not specified') ?></em>";
        }
        html += "</div>";
        
        // Families (Spouses & Children)
        html += "<div class='mb-3' data-field='families'><strong><?= \Fisharebest\Webtrees\I18N::translate('Families:') ?></strong><br>";
        if (data.families && data.families.length > 0) {
            data.families.forEach(fam => {
                html += "<div class='mb-2'>";
                if (fam.husband && fam.husband.xref !== data.xref) html += "<?= \Fisharebest\Webtrees\I18N::translate('Husband:') ?> " + fam.husband.name + "<br>";
                if (fam.wife && fam.wife.xref !== data.xref) html += "<?= \Fisharebest\Webtrees\I18N::translate('Wife:') ?> " + fam.wife.name + "<br>";
                if (fam.children && fam.children.length > 0) {
                    html += "<?= \Fisharebest\Webtrees\I18N::translate('Children:') ?> <ul class='list-unstyled mb-0'>";
                    fam.children.forEach(child => {
                        html += "<li>" + child.name + "</li>";
                    });
                    html += "</ul>";
                }
                html += "</div>";
            });
        } else {
            html += "<em class='text-muted'><?= \Fisharebest\Webtrees\I18N::translate('No families') ?></em>";
        }
        html += "</div>";
        
        html += "</div>";
        return html;
    }

    function highlightDifferences() {
        const currentFields = document.querySelectorAll("#comparison-current .person-details > div");
        const duplicateFields = document.querySelectorAll("#comparison-duplicate .person-details > div");
        
        currentFields.forEach((currentField, index) => {
            const duplicateField = duplicateFields[index];
            if (!duplicateField) return;
            
            const currentText = currentField.textContent.trim();
            const duplicateText = duplicateField.textContent.trim();
            
            // Normalize for comparison (remove "Nicht angegeben" differences)
            const currentNorm = currentText.replace(/<?= \Fisharebest\Webtrees\I18N::translate('Not specified') ?>/g, "").trim();
            const duplicateNorm = duplicateText.replace(/<?= \Fisharebest\Webtrees\I18N::translate('Not specified') ?>/g, "").trim();
            
            if (currentNorm && duplicateNorm && currentNorm !== duplicateNorm) {
                // Different values - highlight in yellow
                currentField.style.backgroundColor = "#fff3cd";
                currentField.style.padding = "8px";
                currentField.style.borderRadius = "4px";
                duplicateField.style.backgroundColor = "#fff3cd";
                duplicateField.style.padding = "8px";
                duplicateField.style.borderRadius = "4px";
            } else if (currentNorm && duplicateNorm) {
                // Matching values - highlight in green
                currentField.style.backgroundColor = "#d1e7dd";
                currentField.style.padding = "8px";
                currentField.style.borderRadius = "4px";
                duplicateField.style.backgroundColor = "#d1e7dd";
                duplicateField.style.padding = "8px";
                duplicateField.style.borderRadius = "4px";
            }
        });
    }

    const getXref = () => {
        const urlParams = new URLSearchParams(window.location.search);
        let xref = urlParams.get("xref") || urlParams.get("indi") || urlParams.get("id") || urlParams.get("key");
        
        const idPattern = /^[A-Z]\d+$/;
        const idInUrlPattern = /\/individual\/([A-Z]\d+)/;

        if (!xref) {
            // Aggressive scan of all URL path segments
            const segments = window.location.pathname.split('/');
            for (const seg of segments) {
                if (seg.match(idPattern)) {
                    xref = seg;
                    break;
                }
            }
        }
        
        if (!xref) {
            // Aggressive scan of all hidden inputs
            const hiddenInputs = document.querySelectorAll('input[type="hidden"]');
            for (const input of hiddenInputs) {
                if (input.value && input.value.match(idPattern)) {
                    if (input.name === 'xref' || input.name === 'indi' || input.name === 'id') {
                        xref = input.value;
                        break;
                    }
                    if (!xref) xref = input.value;
                }
                // Special case: "url" hidden field as seen in logs
                if (input.name === 'url' && input.value) {
                    const match = input.value.match(idInUrlPattern);
                    if (match) {
                        xref = match[1];
                        break;
                    }
                }
            }
        }

        if (!xref) {
            // Try matching anything in the full URL
            const match = window.location.href.match(idInUrlPattern) || 
                          window.location.href.match(/[?&/](indi|xref|id|key)[=/]([A-Z]\d+)/i) || 
                          window.location.href.match(/[?&/]([A-Z]\d+)([?&/]|$)/);
            if (match) xref = match[match.length - 1];
        }

        if (xref) {
            xref = xref.split('.')[0];
            xref = xref.replace(/[^A-Z0-9]/g, '');
        }
        
        return xref;
    };

    const getContext = () => {
        const url = window.location.href;
        const urlParams = new URLSearchParams(window.location.search);
        const urlAction = (urlParams.get('action') || "").toLowerCase();
        const pageTitle = (document.title || "").toLowerCase();
        
        // Resolve form XREF first to help determine context
        let formXref = document.querySelector('input[name="xref"], [id*="xref"], [id*="indi"], [id*="indi_id"]')?.value || "";
        formXref = formXref.replace(/[^A-Z0-9]/g, '');

        // 1. Detect if we are adding a NEW relative (and not just data to a person)
        // If we have a form XREF, we are editing/adding data to an EXISTNG person.
        // If urlAction is edit or contains fact/event, we are not adding a new person.
        const isEditAction = urlAction.includes('edit') || urlAction.includes('update') || 
                             urlAction.includes('fact') || urlAction.includes('event') ||
                             urlAction.includes('change');
        
        const isAdd = (url.includes('add-') || url.includes('add_') || urlAction.includes('add') || 
                       pageTitle.includes('hinzuf√ºgen') || pageTitle.includes('add ')) && 
                       !isEditAction && !formXref;
        
        // 2. Extract XREF from URL (might be the subject or a parent)
        let urlXref = urlParams.get('xref') || urlParams.get('indiv') || urlParams.get('person') || "";
        if (!urlXref) {
           const match = url.match(/\/([XIF]\d+)(\?|&|\/|$)/) || url.match(/[\/&]([XIF]\d+)(\?|&|\/|$)/);
           if (match) urlXref = match[1];
        }

        let xref = document.querySelector('input[name="xref"]')?.value || "";
        let husb = "";
        let wife = "";
        let fam  = "";
        let marr = "";
        let relType = "child"; // default

        const isAddingRelative = urlAction.includes('add_child') || urlAction.includes('add_spouse') || 
                                 urlAction.includes('add_parent') || urlAction.includes('add_indi');
        
        if (isAdd && isAddingRelative) {
            xref = ""; 
            if (urlXref.startsWith('X') || urlXref.startsWith('I')) husb = urlXref;
            if (urlXref.startsWith('F')) fam = urlXref;
            
            // Check for spouse keywords
            if (pageTitle.includes('partner') || pageTitle.includes('spouse') || 
                urlAction.includes('spouse') || url.includes('partner') ||
                document.querySelector('input[id*="MARR"], input[id*="HUSB"], input[id*="WIFE"], [id*="FAM-MARR-DATE"]')) {
                relType = "spouse";
            }
        } else {
            if (!xref) xref = urlXref;
        }

        // 3. Scan DOM for parents/family/marriage
        const allInputs = Array.from(document.querySelectorAll('input, select, textarea'));
        allInputs.forEach(el => {
            let val = (el.value || "").trim();
            if (!val || val.length < 2) return;

            const id = (el.id || "").toUpperCase();
            const name = (el.name || "").toUpperCase();

            // Capture Marriage Date
            if (keywordsIn(['MARR', 'MARRIAGE'], id, name) && keywordsIn(['DATE'], id, name)) {
                if (!marr) marr = val;
            }

            // Normalize XREF
            const cleanVal = val.replace(/@/g, '');
            if (!/^[XIF]\d+$/.test(cleanVal)) return;

            if (cleanVal.startsWith('F')) {
                if (!fam) fam = val;
            } else {
                // Individual XREF
                if (keywordsIn(['HUSB', 'FATH', 'PARENT_H', 'HUSBAND'], id, name)) {
                    husb = val;
                } else if (keywordsIn(['WIFE', 'MOTH', 'PARENT_W', 'MOTHER'], id, name)) {
                    wife = val;
                } else if (name.includes("IVALUES") || id.includes("IVALUES")) {
                    if (!husb) husb = val;
                    else if (!wife && val !== husb) wife = val;
                }
            }
        });

        const clean = (s) => (s || "").replace(/[^A-Z0-9]/g, '');
        const context = { 
            xref: clean(xref), 
            husb: clean(husb), 
            wife: clean(wife), 
            fam: clean(fam),
            marr: marr,
            rel_type: relType
        };
        
        return context;
    };

    const keywordsIn = (keys, id, name) => {
        return keys.some(k => id.includes(k) || name.includes(k));
    };

    // Validation check for data plausibility
    const checkValidation = () => {
        const context = getContext();
        const allElements = Array.from(document.querySelectorAll('input, select, textarea'));
        

        const getVal = (keywords) => {
            const matches = allElements.filter(el => {
                const id = (el.id || "").toUpperCase();
                const name = (el.name || "").toUpperCase();
                return keywords.some(k => id.includes(k) || name.includes(k)) && 
                       (id.includes("DATE") || name.includes("DATE"));
            });
            const found = matches.find(i => i.value && i.value.trim() !== "" && i.value.trim().toUpperCase() !== "Y");
            return found ? found.value.trim() : "";
        };

        const getBestDate = (prefTags, fallbackTags) => {
            let d = getVal(prefTags);
            if (!d) d = getVal(fallbackTags);
            return d;
        };

        const getSex = () => {
            // Search for webtrees-specific radio buttons
            const checkedRadios = allElements.filter(el => el.type === 'radio' && el.checked);
            
            // Strategy A: Fields containing SEX or GEND (standard)
            let found = checkedRadios.find(el => /SEX|GEND/i.test(el.name) || /SEX|GEND/i.test(el.id));
            
            // Strategy B: Any radio with value M/F/U (fallback)
            if (!found) {
                found = checkedRadios.find(el => el.value === 'M' || el.value === 'F' || el.value === 'U');
            }

            // Strategy C: Select fields
            if (!found) {
                found = allElements.find(el => el.tagName === 'SELECT' && (/SEX|GEND/i.test(el.name) || /SEX|GEND/i.test(el.id)));
            }

            if (found) {
                return found.value;
            }
            return "";
        };

        const getNames = (keywords) => {
            const values = allElements
                .filter(el => {
                    const id = (el.id || "").toUpperCase();
                    const name = (el.name || "").toUpperCase();
                    const type = (el.type || "").toLowerCase();
                    
                    if (type === 'hidden' || type === 'submit' || type === 'button') return false;
                    if (id.includes("FILE") || name.includes("FILE") || id.includes("TREE") || name.includes("TREE")) return false;
                    if (el.offsetParent === null) return false; // Skip invisible fields

                    const matchesKeyword = keywords.some(k => id.includes(k) || name.includes(k));
                    const isExclusion = (id.includes("DATE") || name.includes("DATE") || 
                                       id.includes("PLAC") || name.includes("PLAC") ||
                                       id.includes("SEX") || name.includes("SEX") ||
                                       id.includes("GEND") || name.includes("GEND") ||
                                       id.includes("XREF") || name.includes("XREF") ||
                                       id.includes("NOTE") || name.includes("NOTE"));
                    return matchesKeyword && !isExclusion;
                })
                .map(el => (el.value || "").replace(/\//g, "").trim()) // Remove slashes commonly used in GEDCOM fields
                .filter(val => val.length > 0 && val.toUpperCase() !== 'Y' && val.length < 50);
            
            // Deduplicate
            return [...new Set(values)];
        };

        const birth = getBestDate(['BIRT', 'BIRTH'], ['CHR', 'BAPM', 'BAPTISM']);
        const baptism = getVal(['CHR', 'BAPM', 'BAPTISM']);
        const death = getBestDate(['DEAT', 'DEATH'], ['BURI', 'BURIAL', 'CREM']);
        const burial = getVal(['BURI', 'BURIAL', 'CREM']);
        const givens = getNames(['GIVN', 'GIVEN', 'NAME']);
        const surnames = getNames(['SURN', 'SURNAME', 'NAME']);
        const currentSex = getSex();

        if (!context.xref && !context.husb && !context.wife && !context.fam && givens.length === 0 && surnames.length === 0) {
            return;
        }

        const url = "<?= $validation_url ?>" + 
            "?given_name=" + encodeURIComponent(givens.join('|')) + 
            "&surname=" + encodeURIComponent(surnames.join('|')) + 
            "&birth_date=" + encodeURIComponent(birth) +
            "&baptism_date=" + encodeURIComponent(baptism) +
            "&death_date=" + encodeURIComponent(death) +
            "&burial_date=" + encodeURIComponent(burial) +
            "&xref=" + encodeURIComponent(context.xref || "") +
            "&husb=" + encodeURIComponent(context.husb || "") +
            "&wife=" + encodeURIComponent(context.wife || "") +
            "&fam=" + encodeURIComponent(context.fam || "") +
            "&marr_date=" + encodeURIComponent(context.marr || "") +
            "&rel_type=" + encodeURIComponent(context.rel_type || "child") +
            "&sex=" + encodeURIComponent(currentSex);

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error("Server error: " + response.status);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    return;
                }
                let container = document.getElementById("datencheck-validation-container");
                if (!container) {
                    container = document.createElement("div");
                    container.id = "datencheck-validation-container";
                    container.innerHTML = '<div id="datencheck-validation-header"><span><?= \Fisharebest\Webtrees\I18N::translate('‚öñÔ∏è Datencheck') ?></span><span class="close-btn" onclick="this.parentElement.parentElement.style.display=\'none\'">&times;</span></div><div id="datencheck-validation-body"></div>';
                    document.body.appendChild(container);
                    makeDraggable(container, document.getElementById("datencheck-validation-header"));
                }

                const body = document.getElementById("datencheck-validation-body");
                body.innerHTML = "";

                if (data.issues && data.issues.length > 0) {
                    container.style.display = "flex";
                    data.issues.forEach(issue => {
                        const div = document.createElement("div");
                        const icon = issue.severity === "error" ? "‚õî" : issue.severity === "warning" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è";
                        const severityClass = issue.severity === "error" ? "dc-issue-error" : 
                                             issue.severity === "warning" ? "dc-issue-warning" : "dc-issue-info";
                        
                        div.className = "dc-bubble-issue " + severityClass;
                        
                        let taskBtn = "";
                        if (context.xref && /^[XIF]\d+$/.test(context.xref)) {
                            
                            // Define variables for dataset
                            const title = "<?= \Fisharebest\Webtrees\I18N::translate('‚öñÔ∏è Datencheck') ?>: " + issue.label;
                            const note  = issue.message;

                            // Create button safely using DOM API to avoid all escaping hell
                            const btnWrapper = document.createElement("div");
                            btnWrapper.style.marginTop = "5px";
                            btnWrapper.style.textAlign = "right";

                            // 1. Task Button
                            const btn = document.createElement("button");
                            btn.className = "btn btn-sm btn-outline-secondary";
                            btn.dataset.xref = context.xref;
                            btn.dataset.title = title;
                            // Replace newlines just in case, though dataset handles it better
                            btn.dataset.note = note.replace(/(\r\n|\n|\r)/g, " ");
                            btn.innerHTML = "üìå <?= \Fisharebest\Webtrees\I18N::translate('Task') ?>";
                            btn.onclick = function() { window.datencheckSaveTask(this); };
                            btnWrapper.appendChild(btn);

                            // 2. Ignore Button (only if code exists)
                            if (issue.code) {
                                const ignoreBtn = document.createElement("button");
                                ignoreBtn.className = "btn btn-sm btn-outline-secondary";
                                ignoreBtn.style.marginLeft = "5px";
                                ignoreBtn.dataset.xref = context.xref;
                                ignoreBtn.dataset.code = issue.code;
                                ignoreBtn.innerHTML = "üö´ <?= \Fisharebest\Webtrees\I18N::translate('Ignore') ?>";
                                ignoreBtn.onclick = function() { window.datencheckIgnoreError(this); };
                                btnWrapper.appendChild(ignoreBtn);
                            }
                            
                            // Clear innerHTML before appending since we built it with DOM nodes now
                            div.innerHTML = "";
                            const contentDiv = document.createElement("div");
                            contentDiv.innerHTML = "<strong>" + icon + " " + issue.label + "</strong><br>" + issue.message;
                            div.appendChild(contentDiv);
                            div.appendChild(btnWrapper);
                        } else {
                            div.innerHTML = "<strong>" + icon + " " + issue.label + "</strong><br>" + issue.message;
                        }
                        
                        body.appendChild(div);
                    });
                } else {
                    container.style.display = "none";
                }
            })
            .catch(err => {
                console.error("Datencheck: Validation check failed:", err);
            });
    };

    window.datencheckSaveTask = (btn) => {
        const xref  = btn.dataset.xref;
        const title = btn.dataset.title;
        const note  = btn.dataset.note;
        
        btn.disabled = true;
        btn.innerHTML = "‚è≥...";
        // Construct AddTask URL by replacing action
        const baseUrl = "<?= $add_task_url ?>";
        const separator = baseUrl.includes("?") ? "&" : "?";
        const url = baseUrl + separator +
               "xref=" + encodeURIComponent(xref) +
               "&title=" + encodeURIComponent(title) +
               "&note=" + encodeURIComponent(note);
        
        console.log("Saving task to:", url);

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    btn.innerHTML = "‚úÖ <?= \Fisharebest\Webtrees\I18N::translate('Saved') ?>";
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-success');
                    // Optional: remove button after delay
                    setTimeout(() => btn.remove(), 2000);
                } else {
                    btn.innerHTML = "‚ùå <?= \Fisharebest\Webtrees\I18N::translate('Error') ?>";
                    console.error(data.message);
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerHTML = "‚ùå <?= \Fisharebest\Webtrees\I18N::translate('Error') ?>";
                btn.disabled = false;
            });
    };

    window.datencheckIgnoreError = (btn) => {
        const xref = btn.dataset.xref;
        const code = btn.dataset.code;

        if (!confirm('<?= \Fisharebest\Webtrees\I18N::translate('Do you want to ignore this error for this person permanently?') ?>')) {
            return;
        }

        btn.disabled = true;
        btn.innerHTML = "‚è≥...";

        const baseUrl = "<?= $ignore_error_url ?>";
        const separator = baseUrl.includes("?") ? "&" : "?";
        const url = baseUrl + separator +
               "xref=" + encodeURIComponent(xref) +
               "&code=" + encodeURIComponent(code);

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Remove the whole error box
                    const errorBox = btn.closest('.dc-bubble-issue'); // Changed from .alert to .dc-bubble-issue
                    if (errorBox) {
                        errorBox.style.opacity = '0';
                        setTimeout(() => errorBox.remove(), 500);
                    }
                } else {
                    btn.innerHTML = "‚ùå <?= \Fisharebest\Webtrees\I18N::translate('Error') ?>";
                    btn.disabled = false;
                    alert(data.message || '<?= \Fisharebest\Webtrees\I18N::translate('Error while ignoring') ?>');
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerHTML = "‚ùå <?= \Fisharebest\Webtrees\I18N::translate('Error') ?>";
                btn.disabled = false;
            });
    };

    // Run validation on page load for edit forms
    if (window.location.pathname.includes("edit") || window.location.href.includes("edit")) {
        setTimeout(checkValidation, 800);
    }

    const handleInput = (e) => {
        const id = (e.target.id || "").toUpperCase();
        const name = (e.target.name || "").toUpperCase();
        if (id.includes("GIVN") || name.includes("GIVN") || id.includes("SURN") || name.includes("SURN")) {
            clearTimeout(personTimeout);
            personTimeout = setTimeout(() => checkDuplicate(e), 500);
        }
    };

    document.addEventListener("input", (e) => {
        handleInput(e);
        
        const tagName = e.target.tagName;
        if (tagName === "INPUT" || tagName === "SELECT" || tagName === "TEXTAREA") {
            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(checkValidation, 1500);
        }
    });
    document.addEventListener("change", (e) => {
        const tagName = e.target.tagName;
        if (tagName === "INPUT" || tagName === "SELECT" || tagName === "TEXTAREA") {
            clearTimeout(siblingTimeout);
            siblingTimeout = setTimeout(checkSibling, 400);

            clearTimeout(familyTimeout);
            familyTimeout = setTimeout(checkFamily, 300);

            clearTimeout(validationTimeout);
            validationTimeout = setTimeout(checkValidation, 500);
        }
    });
});
</script>
